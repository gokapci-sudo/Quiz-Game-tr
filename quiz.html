<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <span id="question-number" class="yellow-text">...</span>
            <div id="q-timer" style="color: var(--red); font-weight: 900; font-size: 20px;">15s</div>
        </div>
        <div class="card">
            <h2 id="question-text" style="font-size: 18px; min-height: 60px;">Soru yükleniyor...</h2>
            <div id="options-container" style="display: grid; gap: 10px; margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        let questions = [], currentIdx = 0, score = 0, qTimer;
        const startTime = Date.now();

        async function start() {
            const { data } = await supabaseClient.from('questions').select('*').limit(10);
            questions = data;
            showQ();
        }

        function showQ() {
            if (currentIdx >= questions.length) return finish();
            const q = questions[currentIdx];
            document.getElementById('question-number').innerText = `SORU: ${currentIdx + 1}/10`;
            document.getElementById('question-text').innerText = q.question_text;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-sub';
                btn.innerText = opt;
                btn.onclick = () => answer(i);
                container.appendChild(btn);
            });

            let timeLeft = 15;
            document.getElementById('q-timer').innerText = "15s";
            clearInterval(qTimer);
            qTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('q-timer').innerText = timeLeft + "s";
                if (timeLeft <= 0) answer(-1);
            }, 1000);
        }

        function answer(idx) {
            if (idx === questions[currentIdx].correct_option) score += 10;
            currentIdx++;
            showQ();
        }

        async function finish() {
            clearInterval(qTimer);
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);
            const user = window.Telegram.WebApp.initDataUnsafe?.user || { id: APP_CONFIG.adminID };

            await supabaseClient.from('profiles').update({ 
                score: score, 
                completion_time: timeTaken,
                has_ticket: false 
            }).eq('telegram_id', user.id);

            document.body.innerHTML = `
                <div class="container">
                    <div class="card" style="text-align:center; padding:40px 20px;">
                        <h2 class="yellow-text">TEST BİTTİ!</h2>
                        <p style="margin:15px 0;">Skor: ${score} | Süre: ${timeTaken}sn</p>
                        <p style="font-size:12px; opacity:0.7;">Sıralama yarışmadan 4 dakika sonra kesinleşecektir.</p>
                        <button onclick="location.href='dashboard.html'" class="btn-main" style="margin-top:20px;">Dashboard</button>
                    </div>
                </div>`;
        }
        start();
    </script>
</body>
</html>
