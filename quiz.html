<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="quiz-container" class="container">
        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <span id="question-number" style="font-weight: bold; color: var(--yellow);">Soru: 1/10</span>
            <span id="timer" style="color: var(--red); font-weight: bold; font-family: monospace;">15s</span>
        </div>
        <div class="card">
            <h2 id="question-text" style="font-size: 18px; margin-bottom: 20px; min-height: 60px;">Sorular yükleniyor...</h2>
            <div id="options-container" style="display: grid; gap: 10px;"></div>
        </div>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        let questions = [], currentQIndex = 0, score = 0, timeLeft = 15, timerInterval;

        async function startQuiz() {
            const { data, error } = await supabaseClient.from('questions').select('*').limit(10);
            if (error || !data || data.length === 0) {
                tg.showAlert("Soru bulunamadı!");
                location.href = 'dashboard.html';
                return;
            }
            questions = data;
            showQuestion();
        }

        function showQuestion() {
            if (currentQIndex >= questions.length) { finishQuiz(); return; }
            const q = questions[currentQIndex];
            document.getElementById('question-number').innerText = `Soru: ${currentQIndex + 1}/${questions.length}`;
            document.getElementById('question-text').innerText = q.question_text;
            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';
            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn-sub';
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(index);
                optionsDiv.appendChild(btn);
            });
            resetTimer();
        }

        function handleAnswer(selectedIndex) {
            clearInterval(timerInterval);
            if (selectedIndex === questions[currentQIndex].correct_option) score += 10;
            currentQIndex++;
            showQuestion();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timeLeft = 15;
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft + "s";
                if (timeLeft <= 0) handleAnswer(-1);
            }, 1000);
        }

        async function finishQuiz() {
            const user = tg.initDataUnsafe?.user || { id: 1369398784 };
            const { data: profile } = await supabaseClient.from('profiles').select('score').eq('telegram_id', user.id).single();
            const totalScore = (profile?.score || 0) + score;

            // Puanı güncelle ve bileti yak (false yap)
            await supabaseClient.from('profiles').update({ 
                score: totalScore,
                has_ticket: false 
            }).eq('telegram_id', user.id);

            tg.showAlert(`Yarışma Bitti! Puanınız: ${score}`);
            location.href = 'dashboard.html';
        }
        tg.ready(); startQuiz();
    </script>
</body>
</html>
