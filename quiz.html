<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yarışma Başladı!</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="quiz-container">
        <div class="quiz-header">
            <div class="progress-info">Soru: <span id="current-q-index">1</span>/10</div>
            <div id="timer-display">Süre: 0.00s</div>
        </div>

        <div id="question-card" class="card">
            <h3 id="question-text">Soru yükleniyor...</h3>
            <div id="options-container" class="options-grid">
                </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        let questions = [];
        let currentIndex = 0;
        let score = 0;
        let startTime;
        let timerInterval;

        async function startQuiz() {
            // 1. Soruları Supabase'den rastgele 10 tane çek
            const { data, error } = await supabase.from('questions').select('*').limit(10);
            
            if (error || data.length === 0) {
                tg.showAlert("Soru bulunamadı! Lütfen adminin soru eklemesini bekleyin.");
                return;
            }
            
            questions = data;
            startTime = Date.now();
            startTimer();
            showQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('timer-display').innerText = `Süre: ${elapsed.toFixed(2)}s`;
            }, 100);
        }

        function showQuestion() {
            const q = questions[currentIndex];
            document.getElementById('current-q-index').innerText = currentIndex + 1;
            document.getElementById('question-text').innerText = q.question_text;
            
            const container = document.getElementById('options-container');
            container.innerHTML = "";

            q.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "btn-option";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(index);
                container.appendChild(btn);
            });
        }

        async function handleAnswer(selectedIndex) {
            if (selectedIndex === questions[currentIndex].correct_option) {
                score += 10; // Her doğru 10 puan
            }

            if (currentIndex < questions.length - 1) {
                currentIndex++;
                showQuestion();
            } else {
                finishQuiz();
            }
        }

        async function finishQuiz() {
            clearInterval(timerInterval);
            const totalTimeMs = Date.now() - startTime;
            const user = tg.initDataUnsafe?.user;

            // 2. Skoru Liderlik Tablosuna Kaydet
            await supabase.from('leaderboard').insert([{
                telegram_id: user.id,
                username: user.username || "Anonim",
                score: score,
                completion_time_ms: totalTimeMs,
                session_time: getSessionTime() // 10:00, 15:00 veya 20:00
            }]);

            // 3. Bileti Kullanılmış Say (Bileti Sıfırla)
            await supabase.from('profiles').update({ has_ticket: false }).eq('telegram_id', user.id);

            tg.showAlert(`Yarışma Bitti!\nPuan: ${score}\nSüre: ${(totalTimeMs/1000).toFixed(2)}s`, () => {
                window.location.href = "index.html";
            });
        }

        function getSessionTime() {
            const h = new Date().getHours();
            if (h >= 10 && h < 15) return "10:00";
            if (h >= 15 && h < 20) return "15:00";
            return "20:00";
        }

        window.onload = startQuiz;
    </script>
</body>
</html>
