<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div class="card" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent);">
            <span id="question-number" style="font-weight: bold; color: var(--yellow);">Yükleniyor...</span>
            <div style="text-align: right;">
                <div id="quiz-timer" style="color: var(--accent); font-size: 11px; font-weight: bold;">KALAN: 03:00</div>
                <div id="q-timer" style="color: var(--red); font-weight: 900; font-size: 18px;">15s</div>
            </div>
        </div>
        <div class="card">
            <h2 id="question-text" style="font-size: 18px; margin-bottom: 20px; min-height: 60px;">...</h2>
            <div id="options-container" style="display: grid; gap: 10px;"></div>
        </div>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        let questions = [], currentIdx = 0, score = 0;
        let qTimeLeft = 15, quizTimeLeft = 180;
        let qTimer, quizTimer;
        const startTimestamp = Date.now();

        async function start() {
            const { data } = await supabaseClient.from('questions').select('*').limit(20);
            if (!data || data.length === 0) return location.href='dashboard.html';
            questions = data;
            
            quizTimer = setInterval(() => {
                quizTimeLeft--;
                let min = Math.floor(quizTimeLeft / 60);
                let sec = quizTimeLeft % 60;
                document.getElementById('quiz-timer').innerText = `KALAN: ${min}:${sec < 10 ? '0'+sec : sec}`;
                if (quizTimeLeft <= 0) finish();
            }, 1000);
            showQ();
        }

        function showQ() {
            if (currentIdx >= questions.length) return finish();
            const q = questions[currentIdx];
            document.getElementById('question-number').innerText = `SORU: ${currentIdx + 1}/${questions.length}`;
            document.getElementById('question-text').innerText = q.question_text;
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-sub';
                btn.innerText = opt;
                btn.onclick = () => answer(i);
                container.appendChild(btn);
            });
            qTimeLeft = 15;
            clearInterval(qTimer);
            qTimer = setInterval(() => {
                qTimeLeft--;
                document.getElementById('q-timer').innerText = qTimeLeft + "s";
                if (qTimeLeft <= 0) answer(-1);
            }, 1000);
        }

        function answer(idx) {
            if (idx === questions[currentIdx].correct_option) score += 10;
            currentIdx++;
            showQ();
        }

        async function finish() {
            clearInterval(qTimer);
            clearInterval(quizTimer);
            const timeTaken = Math.floor((Date.now() - startTimestamp) / 1000);
            const user = tg.initDataUnsafe?.user || { id: 1369398784 };

            await supabaseClient.from('profiles').update({ 
                score: score, 
                completion_time: timeTaken,
                has_ticket: false 
            }).eq('telegram_id', user.id);

            tg.showAlert(`BİTTİ!\nSkor: ${score}\nSüre: ${timeTaken}sn`);
            location.href = 'dashboard.html';
        }
        start();
    </script>
</body>
</html>
