<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <style>
        .option-btn { width: 100%; background: #242f3d; border: 1px solid #333; color: white; padding: 15px; margin-bottom: 10px; border-radius: 12px; text-align: left; font-size: 15px; transition: 0.2s; cursor: pointer; }
        .option-btn:active { transform: scale(0.98); background: var(--accent); }
        .progress-bar { width: 100%; height: 6px; background: #1c252f; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--yellow); transition: width 0.3s; }
        #timer-display { font-weight: bold; color: var(--yellow); font-family: monospace; font-size: 18px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="quiz-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span id="question-number" style="font-size: 12px; opacity: 0.6;">Y√ºkleniyor...</span>
                <span id="timer-display">00:00</span>
            </div>
            
            <div class="progress-bar">
                <div id="progress-fill"></div>
            </div>

            <div class="card" id="quiz-area">
                <h3 id="question-text" style="margin-bottom: 20px; min-height: 60px;">Sorular Hazƒ±rlanƒ±yor...</h3>
                <div id="options-container"></div>
            </div>
        </div>
    </div>

    <script>
        const tgApp = window.Telegram.WebApp;
        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let startTime;

        async function startQuiz() {
            try {
                // 1. ADIM: Bu yarƒ±≈üma i√ßin belirlenen 10 soru ID'sini √ßek
                const { data: raceData, error: raceError } = await supabaseClient
                    .from('current_race_questions')
                    .select('question_ids')
                    .eq('id', 1)
                    .single();

                if (raceError || !raceData || !raceData.question_ids) {
                    throw new Error("Yarƒ±≈üma sorularƒ± hen√ºz belirlenmedi.");
                }

                // 2. ADIM: Bu ID'lere sahip sorularƒ±n detaylarƒ±nƒ± getir
                const { data: questionsData, error: qError } = await supabaseClient
                    .from('questions')
                    .select('*')
                    .in('id', raceData.question_ids);

                if (qError || !questionsData) throw qError;

                // 3. ADIM: Sorularƒ± ID listesindeki sƒ±raya g√∂re diz (Herkes aynƒ± sƒ±rayƒ± g√∂rs√º)
                questions = raceData.question_ids.map(id => questionsData.find(q => q.id === id)).filter(q => q);

                if (questions.length === 0) throw new Error("Soru havuzu bo≈ü.");

                // Yarƒ±≈ümayƒ± Ba≈ülat
                startTime = Date.now();
                showQuestion();
                setInterval(updateTimer, 1000);

            } catch (err) {
                console.error(err);
                tgApp.showAlert("Hata: " + err.message);
                location.href = 'dashboard.html';
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${mins}:${secs}`;
        }

        function showQuestion() {
            const q = questions[currentIdx];
            document.getElementById('question-text').innerText = q.question_text;
            document.getElementById('question-number').innerText = `Soru: ${currentIdx + 1}/${questions.length}`;
            document.getElementById('progress-fill').style.width = `${((currentIdx) / questions.length) * 100}%`;

            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(i);
                optionsDiv.appendChild(btn);
            });
        }

        function handleAnswer(selectedIdx) {
            if (selectedIdx === questions[currentIdx].correct_option) {
                score++;
            }
            currentIdx++;
            if (currentIdx < questions.length) {
                showQuestion();
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            document.getElementById('progress-fill').style.width = '100%';

            document.getElementById('quiz-area').innerHTML = `
                <div style="text-align:center; padding:10px;">
                    <h2 style="color:var(--yellow); margin-bottom:15px;">üèÅ YARI≈ûMA Bƒ∞TTƒ∞</h2>
                    <p style="font-size:18px; margin-bottom:5px;">Doƒüru: <b>${score}</b> / ${questions.length}</p>
                    <p style="font-size:14px; opacity:0.7; margin-bottom:25px;">S√ºre: <b>${duration}s</b></p>
                    <button id="finish-btn" class="btn-main" style="background:var(--green); border:none; color:white;">YARI≈ûMAYI Bƒ∞Tƒ∞R VE KAYDET</button>
                </div>
            `;

            document.getElementById('finish-btn').onclick = async () => {
                const btn = document.getElementById('finish-btn');
                btn.disabled = true;
                btn.innerText = "KAYDEDƒ∞Lƒ∞YOR...";

                try {
                    const user = tgApp.initDataUnsafe?.user || { id: 123456, username: 'Misafir' };

                    // 1. Skoru Kaydet
                    await supabaseClient.from('results').insert([{ 
                        telegram_id: user.id, 
                        score: score, 
                        duration: parseFloat(duration),
                        username: user.username || "Oyuncu"
                    }]);

                    // 2. Bileti Yak
                    await supabaseClient.from('profiles').update({ has_ticket: false }).eq('telegram_id', user.id);

                    tgApp.showAlert("Skorunuz kaydedildi!", () => {
                        location.href = 'dashboard.html';
                    });
                } catch (err) {
                    tgApp.showAlert("Kayƒ±t hatasƒ±!");
                    btn.disabled = false;
                }
            };
        }

        document.addEventListener('DOMContentLoaded', startQuiz);
    </script>
</body>
</html>
