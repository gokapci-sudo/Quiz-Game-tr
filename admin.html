<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quiz Arena</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <header style="margin-bottom: 20px; padding: 10px;">
        <button onclick="window.location.href='dashboard.html'" class="btn-sub" style="width: auto; display: inline-block;">â¬… Geri</button>
        <h2 style="display: inline-block; margin-left: 10px;">YÃ¶netim Paneli</h2>
    </header>

    <div class="container">
        <section class="card">
            <h3 class="yellow-text">ğŸ† YarÄ±ÅŸma & Ã–dÃ¼l AyarlarÄ±</h3>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; opacity: 0.7;">Toplam Ã–dÃ¼l Havuzu (TON):</label>
                <input type="number" id="admin-prize-input" class="card" style="width:100%; background:#0e1621; color:white; margin-top:5px;" placeholder="Ã–rn: 100">
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; opacity: 0.7;">YarÄ±ÅŸma Saatleri (VirgÃ¼lle ayÄ±r):</label>
                <input type="text" id="admin-times-input" class="card" style="width:100%; background:#0e1621; color:white; margin-top:5px;" placeholder="12:00, 18:00, 21:00">
            </div>
            <button onclick="updateSettings()" class="btn-main" style="margin-top: 10px; background:var(--accent);">AYARLARI KAYDET</button>
        </section>

        <section class="card" style="border: 2px solid var(--red);">
            <h3 style="color:var(--red);">ğŸ YarÄ±ÅŸmayÄ± SonlandÄ±r</h3>
            <p style="font-size: 11px; opacity:0.8; margin-bottom:10px;">Bu buton sÄ±ralamadaki ilk 3 kiÅŸiye Ã¶dÃ¼llerini otomatik daÄŸÄ±tÄ±r ve biletleri sÄ±fÄ±rlar.</p>
            <button onclick="endRaceAndPay()" class="btn-main" style="background:var(--red);">YARIÅI BÄ°TÄ°R & Ã–DE</button>
        </section>

        <section class="card">
            <h3>ğŸ’° Ã‡ekim Talepleri</h3>
            <div id="withdrawal-list"><p>YÃ¼kleniyor...</p></div>
        </section>

        <section class="card">
            <h3>ğŸ“¢ Yeni Duyuru</h3>
            <textarea id="ann-content" class="card" style="width:100%; height:80px; background:#0e1621; border-color:#3b4754; color:white;"></textarea>
            <button onclick="addAnn()" class="btn-main">YayÄ±nla</button>
        </section>

        <section class="card">
            <h3>â“ Soru Ekle</h3>
            <input type="text" id="q-text" placeholder="Soru Metni" class="card" style="width:100%; margin-bottom:5px;">
            <input type="text" id="q-opts" placeholder="A,B,C,D (VirgÃ¼lle ayÄ±r)" class="card" style="width:100%; margin-bottom:5px;">
            <input type="number" id="q-correct" placeholder="DoÄŸru Ä°ndeks (0-3)" class="card" style="width:100%; margin-bottom:10px;">
            <button onclick="addQuest()" class="btn-main">Soruyu Kaydet</button>
        </section>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseAdmin = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        // --- AYARLAR VE Ã–DÃœL YÃ–NETÄ°MÄ° ---

        async function fetchSettings() {
            const { data } = await supabaseAdmin.from('settings').select('*').eq('id', 1).single();
            if (data) {
                document.getElementById('admin-prize-input').value = data.total_prize;
                document.getElementById('admin-times-input').value = data.race_times;
            }
        }

        async function updateSettings() {
            const prize = document.getElementById('admin-prize-input').value;
            const times = document.getElementById('admin-times-input').value;
            
            const { error } = await supabaseAdmin.from('settings').update({
                total_prize: prize,
                race_times: times
            }).eq('id', 1);
            
            if(!error) alert("Ayarlar gÃ¼ncellendi!");
            else alert("Hata: " + error.message);
        }

        async function endRaceAndPay() {
            if(!confirm("YarÄ±ÅŸÄ± bitirip ilk 3 kiÅŸiye Ã¶dÃ¼l daÄŸÄ±tmak istediÄŸinize emin misiniz?")) return;

            // 1. Ayarlardan toplam Ã¶dÃ¼lÃ¼ al
            const { data: sett } = await supabaseAdmin.from('settings').select('*').eq('id', 1).single();
            const totalPrize = parseFloat(sett.total_prize);
            const shares = [0.50, 0.30, 0.20]; // %50, %30, %20

            // 2. Liderlik tablosundaki ilk 3'Ã¼ getir
            const { data: winners } = await supabaseAdmin
                .from('profiles')
                .select('*')
                .order('score', { ascending: false })
                .limit(3);

            if (!winners || winners.length === 0) {
                alert("Kazanan bulunamadÄ±!");
                return;
            }

            // 3. Ã–dÃ¼lleri daÄŸÄ±t ve biletleri/skorlarÄ± sÄ±fÄ±rla (Biletleri sÄ±fÄ±rlamak yeni yarÄ±ÅŸ iÃ§in gereklidir)
            for (let i = 0; i < winners.length; i++) {
                const reward = totalPrize * shares[i];
                const newBalance = parseFloat(winners[i].balance || 0) + reward;
                
                await supabaseAdmin.from('profiles')
                    .update({ balance: newBalance })
                    .eq('telegram_id', winners[i].telegram_id);
            }

            // 4. TÃ¼m kullanÄ±cÄ±larÄ±n skorlarÄ±nÄ± ve biletlerini yeni yarÄ±ÅŸ iÃ§in temizle
            await supabaseAdmin.from('profiles').update({ score: 0, has_ticket: false }).neq('telegram_id', 0);

            alert("YarÄ±ÅŸ bitti! Ä°lk 3'e toplam " + totalPrize + " TON daÄŸÄ±tÄ±ldÄ±. TÃ¼m skorlar ve biletler sÄ±fÄ±rlandÄ±.");
        }

        // --- MEVCUT FONKSÄ°YONLAR ---

        async function loadRequests() {
            const { data } = await supabaseAdmin.from('withdrawals').select('*').eq('status', 'pending');
            const list = document.getElementById('withdrawal-list');
            list.innerHTML = data?.length ? "" : "Bekleyen talep yok.";
            data?.forEach(req => {
                list.innerHTML += `
                    <div class="req-item" style="border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius:8px;">
                        ID: ${req.telegram_id} <br> Miktar: <span class="yellow-text">${req.amount} TON</span> <br>
                        <button onclick="approve('${req.id}', ${req.telegram_id})" class="btn-main" style="padding:5px; margin-top:5px; font-size:12px; background:#31b545;">Ã–DENDÄ° YAP & SIFIRLA</button>
                    </div>`;
            });
        }

        async function approve(reqId, userId) {
            await supabaseAdmin.from('withdrawals').update({ status: 'paid' }).eq('id', reqId);
            await supabaseAdmin.from('profiles').update({ balance: 0.00 }).eq('telegram_id', userId);
            alert("Ã–deme onaylandÄ± ve kullanÄ±cÄ± bakiyesi sÄ±fÄ±rlandÄ±.");
            loadRequests();
        }

        async function addAnn() {
            const content = document.getElementById('ann-content').value;
            await supabaseAdmin.from('announcements').insert([{ content }]);
            alert("Duyuru yayÄ±nlandÄ±.");
            document.getElementById('ann-content').value = "";
        }

        async function addQuest() {
            const text = document.getElementById('q-text').value;
            const opts = document.getElementById('q-opts').value.split(',');
            const correct = document.getElementById('q-correct').value;
            await supabaseAdmin.from('questions').insert([{ 
                question_text: text, 
                options: opts, 
                correct_option: parseInt(correct) 
            }]);
            alert("Soru eklendi.");
            document.getElementById('q-text').value = "";
            document.getElementById('q-opts').value = "";
            document.getElementById('q-correct').value = "";
        }

        // BaÅŸlangÄ±Ã§
        fetchSettings();
        loadRequests();
    </script>
</body>
</html>
