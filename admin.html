<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - Quiz Arena</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header style="display: flex; align-items: center; margin-bottom: 20px;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width: auto; padding: 0 15px;">â¬…</button>
            <h2 style="margin-left: 15px;">ADMIN PANEL</h2>
        </header>

        <section class="card" style="border: 1px solid var(--yellow);">
            <h3 class="yellow-text" style="font-size: 14px; margin-bottom: 10px;">ğŸ† Ã–DÃœL HAVUZU & RESET</h3>
            <input type="number" id="prize-input" placeholder="Toplam Havuz (Ã–rn: 10.5)" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #242f3d; background: var(--bg); color: white; margin-bottom: 10px;">
            <button onclick="updatePrize()" class="btn-main" style="height: 45px; font-size: 14px; margin-bottom: 10px;">HAVUZU GÃœNCELLE</button>
            <button onclick="distributeAndReset()" class="btn-main" style="height: 45px; font-size: 14px; background: var(--red);">ğŸ† Ã–DÃœLLERÄ° DAÄIT VE SIFIRLA</button>
        </section>

        <section class="card">
            <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ’¸ BEKLEYEN Ã‡EKÄ°MLER</h3>
            <div id="withdraw-list" style="max-height: 300px; overflow-y: auto;">
                <div style="text-align: center; opacity: 0.5; padding: 20px;">YÃ¼kleniyor...</div>
            </div>
        </section>

        <section class="card">
            <h3 style="font-size: 14px; margin-bottom: 10px;">â“ YENÄ° SORU EKLE</h3>
            <input type="text" id="q-text" placeholder="Soru metni..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #242f3d; background: var(--bg); color: white; margin-bottom: 8px;">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <input type="text" id="opt-0" placeholder="A ÅÄ±kkÄ±" style="padding: 10px; background: var(--bg); color: white; border: 1px solid #242f3d; border-radius: 8px; font-size: 12px;">
                <input type="text" id="opt-1" placeholder="B ÅÄ±kkÄ±" style="padding: 10px; background: var(--bg); color: white; border: 1px solid #242f3d; border-radius: 8px; font-size: 12px;">
                <input type="text" id="opt-2" placeholder="C ÅÄ±kkÄ±" style="padding: 10px; background: var(--bg); color: white; border: 1px solid #242f3d; border-radius: 8px; font-size: 12px;">
                <input type="text" id="opt-3" placeholder="D ÅÄ±kkÄ±" style="padding: 10px; background: var(--bg); color: white; border: 1px solid #242f3d; border-radius: 8px; font-size: 12px;">
            </div>

            <select id="correct-opt" style="width: 100%; padding: 12px; background: var(--bg); color: var(--yellow); border: 1px solid #242f3d; border-radius: 10px; margin-bottom: 10px;">
                <option value="0">DoÄŸru Cevap: A</option>
                <option value="1">DoÄŸru Cevap: B</option>
                <option value="2">DoÄŸru Cevap: C</option>
                <option value="3">DoÄŸru Cevap: D</option>
            </select>

            <button onclick="saveQuestion()" class="btn-sub" style="background: var(--accent);">SORUYU KAYDET</button>
        </section>

        <section class="card">
            <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ“¢ YENÄ° DUYURU</h3>
            <input type="text" id="ann-input" placeholder="Duyuru metni..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #242f3d; background: var(--bg); color: white;">
            <button onclick="addAnnouncement()" class="btn-sub" style="margin-top: 10px;">YAYINLA</button>
        </section>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        async function checkAdmin() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            if (user.id !== APP_CONFIG.adminID) {
                alert("Yetkisiz EriÅŸim!");
                location.href = 'dashboard.html';
            }
            loadWithdrawals();
        }

        // Ã–dÃ¼l Havuzu GÃ¼ncelleme
        async function updatePrize() {
            const val = document.getElementById('prize-input').value;
            if(!val) return;
            const { error } = await supabaseClient.from('settings').update({ total_prize: val }).eq('id', 1);
            if (!error) tg.showAlert("Ã–dÃ¼l havuzu " + val + " TON olarak gÃ¼ncellendi!");
        }

        // Ã–dÃ¼l DaÄŸÄ±tÄ±m ve SÄ±fÄ±rlama
        async function distributeAndReset() {
            if (!confirm("Ä°lk 3 kiÅŸiye Ã¶dÃ¼lleri yatÄ±rÄ±lacak ve tÃ¼m skorlar silinecek. Emin misiniz?")) return;

            const { data: sett } = await supabaseClient.from('settings').select('total_prize').eq('id', 1).single();
            const pool = parseFloat(sett.total_prize);

            const { data: winners } = await supabaseClient
                .from('profiles')
                .select('*')
                .gt('score', 0)
                .order('score', { ascending: false })
                .order('completion_time', { ascending: true })
                .limit(3);

            if (winners && winners.length > 0) {
                const rates = [0.50, 0.35, 0.15];
                for (let i = 0; i < winners.length; i++) {
                    const prize = pool * rates[i];
                    await supabaseClient.from('profiles').update({ balance: (winners[i].balance || 0) + prize }).eq('telegram_id', winners[i].telegram_id);
                }
            }

            // SkorlarÄ± ve SÃ¼releri SÄ±fÄ±rla (neq: 0 ile tÃ¼m tabloyu hedefler)
            await supabaseClient.from('profiles').update({ score: 0, completion_time: 0 }).neq('telegram_id', 0);
            tg.showAlert("Ã–dÃ¼ller daÄŸÄ±tÄ±ldÄ± ve sistem sÄ±fÄ±rlandÄ±!");
        }

        // Ã‡ekim Taleplerini YÃ¼kle
        async function loadWithdrawals() {
            const list = document.getElementById('withdraw-list');
            const { data, error } = await supabaseClient
                .from('withdrawals')
                .select('*')
                .eq('status', 'pending')
                .order('id', { ascending: false });

            if (error) {
                list.innerHTML = "Hata: " + error.message;
                return;
            }

            if (!data || data.length === 0) {
                list.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">Bekleyen talep yok.</div>';
                return;
            }

            list.innerHTML = data.map(w => `
                <div class="card" style="background: #242f3d; margin-bottom: 8px; font-size: 12px;">
                    <div style="margin-bottom:5px;">ğŸ‘¤ ID: <b>${w.telegram_id}</b></div>
                    <div style="margin-bottom:5px;">ğŸ’° Tutar: <b class="yellow-text">${w.amount} TON</b></div>
                    <div style="margin-bottom:8px; word-break: break-all; opacity:0.7;">ğŸ’ ${w.wallet_address}</div>
                    <button onclick="approveWithdraw(${w.id})" class="btn-sub" style="height: 30px; background: var(--green); font-size:11px;">Ã–DENDÄ° OLARAK Ä°ÅARETLE</button>
                </div>
            `).join('');
        }

        async function approveWithdraw(id) {
            const { error } = await supabaseClient.from('withdrawals').update({ status: 'completed' }).eq('id', id);
            if (!error) {
                tg.showAlert("Ä°ÅŸlem onaylandÄ±.");
                loadWithdrawals();
            }
        }

        // Soru Kaydetme (Mobil Uyumlu)
        async function saveQuestion() {
            const qText = document.getElementById('q-text').value;
            const opts = [
                document.getElementById('opt-0').value,
                document.getElementById('opt-1').value,
                document.getElementById('opt-2').value,
                document.getElementById('opt-3').value
            ];
            const correct = parseInt(document.getElementById('correct-opt').value);

            if(!qText || opts.some(o => !o)) {
                tg.showAlert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
                return;
            }

            const { error } = await supabaseClient.from('questions').insert([{
                question_text: qText,
                options: opts,
                correct_option: correct
            }]);

            if(!error) {
                tg.showAlert("Soru baÅŸarÄ±yla eklendi!");
                document.getElementById('q-text').value = "";
                for(let i=0; i<4; i++) document.getElementById('opt-'+i).value = "";
            }
        }

        async function addAnnouncement() {
            const txt = document.getElementById('ann-input').value;
            if(!txt) return;
            const { error } = await supabaseClient.from('announcements').insert([{ content: txt }]);
            if(!error) {
                tg.showAlert("Duyuru yayÄ±nlandÄ±!");
                document.getElementById('ann-input').value = "";
            }
        }

        checkAdmin();
    </script>
</body>
</html>
