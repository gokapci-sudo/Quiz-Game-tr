<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Admin Kontrol Paneli</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="admin-body">
    <h2>ğŸ›  Admin YÃ¶netim Paneli</h2>

    <section class="admin-section">
        <h3>ğŸ’° Ã‡ekim Talepleri</h3>
        <div id="withdrawal-list">YÃ¼kleniyor...</div>
    </section>

    <section class="admin-section">
        <h3>ğŸ“¢ Duyuru YayÄ±nla</h3>
        <textarea id="announcement-text" placeholder="Duyuru metni..."></textarea>
        <button onclick="postAnnouncement()" class="btn-main">YayÄ±nla</button>
    </section>

    <section class="admin-section">
        <h3>â“ Soru Ekle</h3>
        <input type="text" id="q-text" placeholder="Soru nedir?">
        <input type="text" id="q-options" placeholder="A,B,C,D (VirgÃ¼lle ayÄ±r)">
        <input type="number" id="q-correct" placeholder="DoÄŸru ÅÄ±k Ä°ndeksi (0-3)">
        <button onclick="addQuestion()" class="btn-main">Soru Kaydet</button>
    </section>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseAdmin = supabase.createClient(SB_URL, SB_KEY);

        // Ã‡ekim Taleplerini Listele
        async function fetchRequests() {
            const { data } = await supabaseAdmin.from('withdrawals').select('*').eq('status', 'pending');
            let html = "";
            data?.forEach(req => {
                html += `
                    <div class="req-item">
                        ID: ${req.telegram_id} | Miktar: ${req.amount} TON <br>
                        CÃ¼zdan: ${req.wallet_address} <br>
                        <button onclick="approveWithdraw('${req.id}', ${req.telegram_id})" class="btn-approve">Ã–dendi Yap & SÄ±fÄ±rla</button>
                    </div><hr>`;
            });
            document.getElementById('withdrawal-list').innerHTML = html || "Bekleyen talep yok.";
        }

        // Ã–dendi Yap ve Bakiyeyi SÄ±fÄ±rla
        async function approveWithdraw(requestId, userId) {
            // 1. Talebi gÃ¼ncelle
            await supabaseAdmin.from('withdrawals').update({ status: 'paid' }).eq('id', requestId);
            // 2. KullanÄ±cÄ± bakiyesini sÄ±fÄ±rla
            await supabaseAdmin.from('profiles').update({ balance: 0.00 }).eq('telegram_id', userId);
            
            alert("Ä°ÅŸlem baÅŸarÄ±lÄ±! Bakiye sÄ±fÄ±rlandÄ±.");
            fetchRequests();
        }

        // Duyuru Ekle
        async function postAnnouncement() {
            const content = document.getElementById('announcement-text').value;
            await supabaseAdmin.from('announcements').insert([{ content }]);
            alert("Duyuru yayÄ±nlandÄ±!");
        }

        window.onload = fetchRequests;
    </script>
</body>
</html>
