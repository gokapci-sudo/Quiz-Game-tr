<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - Quiz Arena</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header style="display: flex; align-items: center; margin-bottom: 20px;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width: auto; padding: 0 15px;">â¬…</button>
            <h2 style="margin-left: 15px;">KUMANDA MERKEZÄ°</h2>
        </header>

        <section class="card" style="border: 1px solid var(--yellow);">
            <h3 class="yellow-text" style="font-size: 14px; margin-bottom: 10px;">ğŸ† Ã–DÃœL HAVUZU & RESET</h3>
            <input type="number" id="prize-input" placeholder="Toplam Havuz (Ã–rn: 10.5)" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #242f3d; background: var(--bg); color: white; margin-bottom: 10px;">
            <button onclick="updatePrize()" class="btn-main" style="height: 40px; font-size: 14px; margin-bottom: 10px;">HAVUZU GÃœNCELLE</button>
            <button onclick="distributeAndReset()" class="btn-main" style="height: 40px; font-size: 14px; background: var(--red);">ğŸ† Ã–DÃœLLERÄ° DAÄIT VE SIFIRLA</button>
            <p style="font-size: 10px; opacity: 0.6; margin-top: 5px;">* SÄ±fÄ±rla butonu; ilk 3'e bakiyelerini ekler ve tÃ¼m skorlarÄ± temizler.</p>
        </section>

        <section class="card">
            <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ’¸ Ã‡EKÄ°M TALEPLERÄ°</h3>
            <div id="withdraw-list" style="font-size: 12px;">
                <div style="text-align: center; opacity: 0.5;">Talep bekleniyor...</div>
            </div>
        </section>

        <section class="card">
            <h3 style="font-size: 14px; margin-bottom: 10px;">â“ SORU EKLE (JSON)</h3>
            <textarea id="question-json" placeholder='{"question_text": "Soru?", "options": ["A","B","C","D"], "correct_option": 0}' style="width: 100%; height: 80px; background: var(--bg); color: white; border-radius: 10px; padding: 10px; font-size: 12px;"></textarea>
            <button onclick="addQuestion()" class="btn-sub" style="margin-top: 10px; background: var(--accent);">SORU KAYDET</button>
        </section>

        <section class="card">
            <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ“¢ YENÄ° DUYURU</h3>
            <input type="text" id="ann-input" placeholder="Duyuru metni..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #242f3d; background: var(--bg); color: white;">
            <button onclick="addAnnouncement()" class="btn-sub" style="margin-top: 10px;">YAYINLA</button>
        </section>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        // --- YETKÄ° KONTROLÃœ ---
        async function checkAdmin() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            if (user.id !== APP_CONFIG.adminID) {
                alert("Yetkisiz EriÅŸim!");
                location.href = 'dashboard.html';
            }
            loadWithdrawals();
        }

        // --- 1. Ã–DÃœL GÃœNCELLEME ---
        async function updatePrize() {
            const val = document.getElementById('prize-input').value;
            const { error } = await supabaseClient.from('settings').update({ total_prize: val }).eq('id', 1);
            if (!error) tg.showAlert("Ã–dÃ¼l havuzu gÃ¼ncellendi!");
        }

        // --- 2. Ã–DÃœL DAÄITIMI VE SIFIRLAMA (KRÄ°TÄ°K) ---
        async function distributeAndReset() {
            if (!confirm("Dikkat! Ä°lk 3'e Ã¶dÃ¼lleri yatÄ±rÄ±lacak ve tÃ¼m skorlar silinecek. OnaylÄ±yor musunuz?")) return;

            // Havuzu Al
            const { data: sett } = await supabaseClient.from('settings').select('total_prize').eq('id', 1).single();
            const pool = parseFloat(sett.total_prize);

            // Ä°lk 3'Ã¼ Getir
            const { data: winners } = await supabaseClient
                .from('profiles')
                .select('*')
                .gt('score', 0)
                .order('score', { ascending: false })
                .order('completion_time', { ascending: true })
                .limit(3);

            if (winners && winners.length > 0) {
                // Ã–dÃ¼l OranlarÄ±: %50, %35, %15
                const rates = [0.50, 0.35, 0.15];
                for (let i = 0; i < winners.length; i++) {
                    const prizeAmount = pool * rates[i];
                    const newBalance = (winners[i].balance || 0) + prizeAmount;
                    await supabaseClient.from('profiles').update({ balance: newBalance }).eq('telegram_id', winners[i].telegram_id);
                }
            }

            // TÃœM SKORLARI SIFIRLA
            const { error } = await supabaseClient.from('profiles').update({ score: 0, completion_time: 0 }).neq('telegram_id', 0);
            
            if (!error) tg.showAlert("Ã–dÃ¼ller daÄŸÄ±tÄ±ldÄ± ve sistem sÄ±fÄ±rlandÄ±!");
        }

        // --- 3. Ã‡EKÄ°M TALEPLERÄ°NÄ° YÃ–NET ---
        async function loadWithdrawals() {
            const { data } = await supabaseClient.from('withdrawals').select('*').eq('status', 'pending');
            const list = document.getElementById('withdraw-list');
            if (data && data.length > 0) {
                list.innerHTML = data.map(w => `
                    <div class="card" style="background: rgba(255,255,255,0.05); margin-bottom: 5px; padding: 10px;">
                        ID: ${w.telegram_id} <br>
                        Miktar: <b>${w.amount} TON</b> <br>
                        Adres: <small>${w.wallet_address}</small> <br>
                        <button onclick="approveWithdraw(${w.id}, ${w.telegram_id}, ${w.amount})" class="btn-sub" style="height: 30px; margin-top: 5px; background: var(--green);">Ã–DENDÄ° Ä°ÅARETLE</button>
                    </div>
                `).join('');
            }
        }

        async function approveWithdraw(id, userId, amount) {
            // Bakiyeden dÃ¼ÅŸ (Ã‡ekim talep edildiÄŸinde dÃ¼ÅŸmediysek burada dÃ¼ÅŸÃ¼yoruz)
            const { data: user } = await supabaseClient.from('profiles').select('balance').eq('telegram_id', userId).single();
            await supabaseClient.from('profiles').update({ balance: user.balance - amount }).eq('telegram_id', userId);
            
            // Talebi gÃ¼ncelle
            await supabaseClient.from('withdrawals').update({ status: 'completed' }).eq('id', id);
            tg.showAlert("Ä°ÅŸlem tamamlandÄ±.");
            loadWithdrawals();
        }

        // --- 4. SORU VE DUYURU ---
        async function addQuestion() {
            const raw = document.getElementById('question-json').value;
            const q = JSON.parse(raw);
            await supabaseClient.from('questions').insert([q]);
            tg.showAlert("Soru eklendi.");
        }

        async function addAnnouncement() {
            const txt = document.getElementById('ann-input').value;
            await supabaseClient.from('announcements').insert([{ content: txt }]);
            tg.showAlert("Duyuru yayÄ±nlandÄ±.");
        }

        checkAdmin();
    </script>
</body>
</html>
