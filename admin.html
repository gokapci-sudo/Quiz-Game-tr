<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netim Paneli - Quiz Arena</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header style="margin-bottom: 20px; padding: 10px; display: flex; align-items: center; gap: 15px;">
        <button onclick="window.location.href='dashboard.html'" class="btn-sub" style="width: auto;">â¬… Geri</button>
        <h2 style="margin: 0;">YÃ¶netim Paneli</h2>
    </header>

    <div class="container">
        <section class="card">
            <h3 style="color: var(--yellow);">ğŸ† YarÄ±ÅŸma & Ã–dÃ¼l AyarlarÄ±</h3>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; opacity: 0.7;">Toplam Ã–dÃ¼l Havuzu (TON):</label>
                <input type="number" id="admin-prize-input" class="card" style="width:100%; margin-top:5px;" placeholder="Ã–rn: 100">
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; opacity: 0.7;">YarÄ±ÅŸma Saatleri (Ã–rn: 12:00, 18:00, 21:00):</label>
                <input type="text" id="admin-times-input" class="card" style="width:100%; margin-top:5px;" placeholder="VirgÃ¼lle ayÄ±rÄ±n">
            </div>
            <button onclick="updateSettings()" class="btn-main" style="margin-top: 10px;">AYARLARI KAYDET</button>
        </section>

        <section class="card" style="border: 1px solid var(--red);">
            <h3 style="color: var(--red);">ğŸ YarÄ±ÅŸmayÄ± SonlandÄ±r</h3>
            <p style="font-size: 11px; opacity:0.8;">Bu iÅŸlem ilk 3 kiÅŸiye Ã¶dÃ¼l daÄŸÄ±tÄ±r, skorlarÄ± ve sÃ¼releri sÄ±fÄ±rlar.</p>
            <button onclick="endRaceAndPay()" class="btn-main" style="background: var(--red);">Ã–DÃœLLERÄ° DAÄIT & SKORLARI SIFIRLA</button>
        </section>

        <section class="card">
            <h3>ğŸ’° Bekleyen Ã‡ekimler</h3>
            <div id="withdrawal-list"><p>YÃ¼kleniyor...</p></div>
        </section>

        <section class="card">
            <h3>â“ Yeni Soru Ekle</h3>
            <input type="text" id="q-text" placeholder="Soru Metni" class="card" style="width:100%; margin-bottom:5px;">
            <input type="text" id="q-opts" placeholder="A,B,C,D (VirgÃ¼lle ayÄ±r)" class="card" style="width:100%; margin-bottom:5px;">
            <input type="number" id="q-correct" placeholder="DoÄŸru Ä°ndeks (0-3)" class="card" style="width:100%; margin-bottom:10px;">
            <button onclick="addQuest()" class="btn-main">Soruyu Kaydet</button>
        </section>

        <section class="card">
            <h3>ğŸ“¢ Duyuru YayÄ±nla</h3>
            <textarea id="ann-content" class="card" style="width:100%; height:60px; color:white;"></textarea>
            <button onclick="addAnn()" class="btn-main">Duyuruyu PaylaÅŸ</button>
        </section>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseAdmin = supabase.createClient(SB_URL, SB_KEY);

        // AYARLARI YÃœKLE
        async function fetchSettings() {
            const { data } = await supabaseAdmin.from('settings').select('*').eq('id', 1).single();
            if (data) {
                document.getElementById('admin-prize-input').value = data.total_prize;
                document.getElementById('admin-times-input').value = data.race_times;
            }
        }

        // AYARLARI GÃœNCELLE
        async function updateSettings() {
            const prize = document.getElementById('admin-prize-input').value;
            const times = document.getElementById('admin-times-input').value;
            const { error } = await supabaseAdmin.from('settings').update({
                total_prize: prize, race_times: times
            }).eq('id', 1);
            if(!error) alert("Ayarlar gÃ¼ncellendi!");
        }

        // Ã–DÃœL DAÄIT VE SIFIRLA
        async function endRaceAndPay() {
            if(!confirm("Emin misiniz? Ä°lk 3 kiÅŸiye Ã¶dÃ¼l daÄŸÄ±tÄ±lacak.")) return;

            const { data: sett } = await supabaseAdmin.from('settings').select('*').eq('id', 1).single();
            const totalPrize = parseFloat(sett.total_prize);
            const shares = [0.5, 0.3, 0.2];

            // En yÃ¼ksek skor, skor eÅŸitse en kÄ±sa sÃ¼rede bitiren (completion_time ascending)
            const { data: winners } = await supabaseAdmin.from('profiles')
                .select('*').order('score', { ascending: false }).order('completion_time', { ascending: true }).limit(3);

            if (winners) {
                for (let i = 0; i < winners.length; i++) {
                    const reward = totalPrize * (shares[i] || 0);
                    const newBal = parseFloat(winners[i].balance || 0) + reward;
                    await supabaseAdmin.from('profiles').update({ balance: newBal }).eq('telegram_id', winners[i].telegram_id);
                }
            }

            // SkorlarÄ± ve sÃ¼releri temizle (Biletler zaten 4. dakikada Dashboard tarafÄ±ndan kilitlendi)
            await supabaseAdmin.from('profiles').update({ score: 0, completion_time: 0 }).neq('telegram_id', 0);
            alert("Ä°ÅŸlem BaÅŸarÄ±lÄ±: Ã–dÃ¼ller daÄŸÄ±tÄ±ldÄ± ve skorlar temizlendi.");
        }

        // Ã‡EKÄ°M TALEPLERÄ°NÄ° YÃœKLE
        async function loadRequests() {
            const { data } = await supabaseAdmin.from('withdrawals').select('*').eq('status', 'pending');
            const list = document.getElementById('withdrawal-list');
            list.innerHTML = data?.length ? "" : "Bekleyen talep yok.";
            data?.forEach(req => {
                list.innerHTML += `
                    <div style="border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius:8px; font-size:12px;">
                        KullanÄ±cÄ±: ${req.telegram_id} <br> Miktar: <b>${req.amount} TON</b> <br>
                        <button onclick="approve('${req.id}', ${req.telegram_id})" class="btn-main" style="padding:5px; margin-top:5px; background:#31b545;">ONAYLA (Ã–DENDÄ°)</button>
                    </div>`;
            });
        }

        async function approve(reqId, userId) {
            await supabaseAdmin.from('withdrawals').update({ status: 'paid' }).eq('id', reqId);
            await supabaseAdmin.from('profiles').update({ balance: 0.00 }).eq('telegram_id', userId);
            alert("Ã–deme onaylandÄ±.");
            loadRequests();
        }

        async function addQuest() {
            const text = document.getElementById('q-text').value;
            const opts = document.getElementById('q-opts').value.split(',');
            const correct = document.getElementById('q-correct').value;
            await supabaseAdmin.from('questions').insert([{ question_text: text, options: opts, correct_option: parseInt(correct) }]);
            alert("Soru eklendi.");
        }

        async function addAnn() {
            const content = document.getElementById('ann-content').value;
            await supabaseAdmin.from('announcements').insert([{ content }]);
            alert("Duyuru yayÄ±nlandÄ±.");
        }

        fetchSettings();
        loadRequests();
    </script>
</body>
</html>
