<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src='//libtl.com/sdk.js' data-zone='10527452' data-sdk='show_10527452'></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <header style="padding: 10px 0;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width:auto; padding:10px 20px;">â¬… Geri DÃ¶n</button>
        </header>

        <div class="card" style="text-align:center;">
            <div style="font-size:50px; margin-bottom:10px;">Interstital</div>
            <h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2>
            <p style="opacity:0.7; font-size:13px;">5 Reklam izleyerek veya 0.10 TON karÅŸÄ±lÄ±ÄŸÄ±nda bilet alabilirsiniz.</p>
        </div>
        
        <div class="card" style="border: 2px dashed var(--accent);">
            <h3 style="margin-bottom:10px;">ðŸ“º Ãœcretsiz Bilet</h3>
            <p id="status-text" style="margin-bottom:15px;">Ä°zlenen Reklam: <b id="count" class="yellow-text">0</b> / 5</p>
            <button id="ad-btn" onclick="watchAd()" class="btn-main">REKLAM Ä°ZLE</button>
        </div>

        <div class="card">
            <h3>ðŸ’° Bakiye Ä°le Al</h3>
            <p style="opacity:0.7; font-size:12px; margin-bottom:10px;">Bakiyenizden 0.10 TON dÃ¼ÅŸÃ¼lÃ¼r.</p>
            <button onclick="buyTicket()" class="btn-main" style="background:var(--accent);">0.10 TON Ä°LE SATIN AL</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // Reklam sayÄ±sÄ±nÄ± localStorage'dan gÃ¼venli Ã§ek
        let adCount = parseInt(localStorage.getItem('quiz_ads_watched')) || 0;
        
        // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda sayacÄ± gÃ¼ncelle
        document.getElementById('count').innerText = adCount;

        function watchAd() {
            // ReklamÄ±n ayrÄ± tarayÄ±cÄ±da aÃ§Ä±lmasÄ± ve SDK kontrolÃ¼
            if (typeof show_10527452 !== 'function') {
                tg.showAlert("Reklam henÃ¼z hazÄ±r deÄŸil, lÃ¼tfen birkaÃ§ saniye bekleyin.");
                return;
            }

            // Butonu geÃ§ici olarak kilitle
            const btn = document.getElementById('ad-btn');
            btn.disabled = true;
            btn.innerText = "YÃœKLENÄ°YOR...";

            // ReklamÄ± GÃ¶ster
            show_10527452('pop').then(() => {
                // Reklam baÅŸarÄ±yla kapandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
                adCount++;
                localStorage.setItem('quiz_ads_watched', adCount);
                document.getElementById('count').innerText = adCount;
                
                btn.disabled = false;
                btn.innerText = "REKLAM Ä°ZLE";

                if (adCount >= 5) {
                    grantTicket("Reklam izleme tamamlandÄ±!");
                } else {
                    tg.showConfirm(`Reklam baÅŸarÄ±yla sayÄ±ldÄ±! Kalan: ${5 - adCount}. Devam etmek ister misiniz?`);
                }
            }).catch((err) => {
                btn.disabled = false;
                btn.innerText = "REKLAM Ä°ZLE";
                console.error("Reklam HatasÄ±:", err);
                // BazÄ± durumlarda reklam dÄ±ÅŸ tarayÄ±cÄ±ya yÃ¶nlendirme yaparsa openLink kullan:
                tg.openLink("https://libtl.com/your-ad-link"); // Buraya kendi reklam linkini de koyabilirsin
            });
        }

        async function buyTicket() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            const { data: p, error } = await supabaseClient.from('profiles').select('balance').eq('telegram_id', user.id).single();

            if (p && p.balance >= 0.10) {
                const { error: upErr } = await supabaseClient.from('profiles').update({ balance: p.balance - 0.10 }).eq('telegram_id', user.id);
                if (!upErr) grantTicket("Bilet satÄ±n alÄ±ndÄ±!");
            } else {
                tg.showAlert("Bakiyeniz yetersiz (Min: 0.10 TON).");
            }
        }

        async function grantTicket(msg) {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            const { error } = await supabaseClient.from('profiles').update({ has_ticket: true }).eq('telegram_id', user.id);
            
            if (!error) {
                localStorage.setItem('quiz_ads_watched', 0); // SayacÄ± sÄ±fÄ±rla
                tg.showAlert(msg);
                location.href = "dashboard.html";
            }
        }

        // Telegram linklerini dÄ±ÅŸarÄ±da aÃ§mak iÃ§in genel kural
        document.addEventListener('click', function (e) {
            if (e.target.tagName === 'A' && e.target.href.startsWith('http')) {
                e.preventDefault();
                tg.openLink(e.target.href);
            }
        });
    </script>
</body>
</html>
