<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    
    <script src='//libtl.com/sdk.js' data-zone='10527452' data-sdk='show_10527452'></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <header style="margin-bottom: 20px;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width: auto; padding: 10px 20px;">â¬… Geri DÃ¶n</button>
        </header>

        <div class="card" style="text-align: center; border: 1px solid var(--yellow);">
            <div style="font-size: 40px;">ðŸŽ«</div>
            <h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2>
            <p style="font-size: 13px; opacity: 0.8; margin-top: 5px;">Ãœcretsiz bilet iÃ§in reklamlarÄ± tamamlayÄ±n.</p>
        </div>

        <div class="card" style="border: 1px dashed var(--accent);">
            <h3 style="font-size: 16px; margin-bottom: 10px;">ðŸ“º Ãœcretsiz Bilet</h3>
            
            <div id="ad-progress-container" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span>Ä°lerleyiÅŸ</span>
                    <span id="ad-count-text">0 / 5</span>
                </div>
                <div style="width: 100%; height: 10px; background: #0e1621; border-radius: 5px; overflow: hidden; border: 1px solid #242f3d;">
                    <div id="ad-bar" style="width: 0%; height: 100%; background: var(--accent); transition: 0.5s ease-in-out;"></div>
                </div>
            </div>

            <button id="ad-btn" class="btn-main" onclick="watchAd()">REKLAM Ä°ZLE (+1)</button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px;">Veya hemen satÄ±n al:</span>
                <button onclick="buyTicket()" style="background: var(--yellow); color: black; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer;">1.00 TON</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        // HafÄ±zadan reklam sayÄ±sÄ±nÄ± Ã§ek
        let watchedAds = parseInt(localStorage.getItem('ad_progress')) || 0;

        function updateAdUI() {
            const percent = (watchedAds / 5) * 100;
            document.getElementById('ad-bar').style.width = percent + "%";
            document.getElementById('ad-count-text').innerText = `${watchedAds} / 5`;
            localStorage.setItem('ad_progress', watchedAds);
        }

        function watchAd() {
            const btn = document.getElementById('ad-btn');
            
            // SDK YÃ¼klenmiÅŸ mi kontrol et
            if (typeof show_10527452 !== 'function') {
                tg.showAlert("Reklam servisi yÃ¼kleniyor, lÃ¼tfen birkaÃ§ saniye bekleyip tekrar deneyin.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "â³ Reklam AÃ§Ä±lÄ±yor...";

            // Monetag Rewarded Popup Ã‡aÄŸrÄ±sÄ±
            show_10527452('pop').then(() => {
                // BaÅŸarÄ±lÄ± Ä°zleme
                watchedAds++;
                updateAdUI();
                
                if (watchedAds >= 5) {
                    grantFreeTicket();
                } else {
                    tg.showAlert(`Reklam tamamlandÄ±! Kalan: ${5 - watchedAds}`);
                    resetButton();
                }
            }).catch(e => {
                // Hata Durumu
                tg.showAlert("Reklam yÃ¼klenemedi. LÃ¼tfen internetinizi kontrol edin veya AdBlock kapatÄ±n.");
                resetButton();
            });
        }

        function resetButton() {
            const btn = document.getElementById('ad-btn');
            btn.disabled = false;
            btn.innerText = "REKLAM Ä°ZLE (+1)";
        }

        async function grantFreeTicket() {
            const user = tg.initDataUnsafe?.user || { id: 1369398784 };
            const { error } = await supabaseClient
                .from('profiles')
                .update({ has_ticket: true })
                .eq('telegram_id', user.id);

            if (!error) {
                localStorage.removeItem('ad_progress'); // SayaÃ§ sÄ±fÄ±rla
                tg.showAlert("Tebrikler! 5 reklamÄ± tamamladÄ±nÄ±z, biletiniz aktif edildi.");
                window.location.href = "dashboard.html";
            }
        }

        async function buyTicket() {
            const user = tg.initDataUnsafe?.user || { id: 1369398784 };
            const { data } = await supabaseClient.from('profiles').select('balance').eq('telegram_id', user.id).single();
            
            if (data && data.balance >= 1.00) {
                await supabaseClient.from('profiles').update({ balance: data.balance - 1, has_ticket: true }).eq('telegram_id', user.id);
                tg.showAlert("Bilet satÄ±n alÄ±ndÄ±!");
                window.location.href = "dashboard.html";
            } else {
                tg.showAlert("Bakiyeniz yetersiz.");
            }
        }

        // BaÅŸlangÄ±Ã§ ayarlarÄ±
        tg.ready();
        tg.expand();
        updateAdUI();
    </script>
</body>
</html>
