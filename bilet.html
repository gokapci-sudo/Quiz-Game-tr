<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <header style="margin-bottom: 20px;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width: auto; padding: 10px 20px;">â¬… Geri</button>
        </header>

        <div class="card" style="text-align: center; border: 1px solid var(--yellow);">
            <div style="font-size: 40px;">ðŸŽ«</div>
            <h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2>
            <p style="font-size: 13px; opacity: 0.8; margin-top: 5px;">YarÄ±ÅŸmaya katÄ±lmak iÃ§in bir yÃ¶ntem seÃ§in.</p>
        </div>

        <div class="card">
            <h3 style="font-size: 16px; margin-bottom: 10px;">ðŸš€ HÄ±zlÄ± KatÄ±lÄ±m</h3>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Bilet Ãœcreti:</span>
                <b class="yellow-text">1.00 TON</b>
            </div>
            <button id="buy-btn" class="btn-main" onclick="buyTicket()">HEMEN SATIN AL</button>
        </div>

        <div class="card" style="border: 1px dashed var(--accent);">
            <h3 style="font-size: 16px; margin-bottom: 10px;">ðŸ“º Ãœcretsiz Bilet</h3>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px;">5 adet kÄ±sa reklam izleyerek biletinizi Ã¼cretsiz alabilirsiniz.</p>
            
            <div id="ad-progress-container" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span>Ä°zlenen Reklam</span>
                    <span id="ad-count-text">0 / 5</span>
                </div>
                <div style="width: 100%; height: 8px; background: #0e1621; border-radius: 4px; overflow: hidden;">
                    <div id="ad-bar" style="width: 0%; height: 100%; background: var(--accent); transition: 0.3s;"></div>
                </div>
            </div>

            <button id="ad-btn" class="btn-sub" style="background: var(--accent);" onclick="watchAd()">REKLAM Ä°ZLE (+1)</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;
        const MY_ID = 1369398784;

        let watchedAds = 0;
        let userBalance = 0;

        async function init() {
            tg.ready();
            const user = tg.initDataUnsafe?.user || { id: MY_ID };
            const { data } = await supabaseClient.from('profiles').select('*').eq('telegram_id', user.id).single();
            
            if (data) {
                userBalance = data.balance || 0;
                if (data.has_ticket) {
                    document.body.innerHTML = '<div class="container"><div class="card" style="text-align:center;"><h3>âœ… Biletiniz Mevcut</h3><button onclick="location.href=\'dashboard.html\'" class="btn-main" style="margin-top:15px;">Dashboard\'a DÃ¶n</button></div></div>';
                }
            }
        }

        function watchAd() {
            // BURASI MONETAG TETÄ°KLEME ALANI OLACAK
            // Åžimdilik simÃ¼le ediyoruz:
            watchedAds++;
            updateAdUI();

            if (watchedAds >= 5) {
                grantFreeTicket();
            } else {
                tg.showAlert(`Reklam baÅŸarÄ±yla izlendi! Kalan: ${5 - watchedAds}`);
            }
        }

        function updateAdUI() {
            const percent = (watchedAds / 5) * 100;
            document.getElementById('ad-bar').style.width = percent + "%";
            document.getElementById('ad-count-text').innerText = `${watchedAds} / 5`;
        }

        async function grantFreeTicket() {
            const user = tg.initDataUnsafe?.user || { id: MY_ID };
            const { error } = await supabaseClient.from('profiles').update({ has_ticket: true }).eq('telegram_id', user.id);
            
            if (!error) {
                tg.showAlert("Tebrikler! 5 reklam izleyerek Ã¼cretsiz biletinizi kazandÄ±nÄ±z.");
                location.href = "dashboard.html";
            }
        }

        async function buyTicket() {
            if (userBalance < 1) {
                tg.showAlert("Yetersiz bakiye! LÃ¼tfen reklam izleyerek bilet alÄ±n.");
                return;
            }
            const user = tg.initDataUnsafe?.user || { id: MY_ID };
            await supabaseClient.from('profiles').update({ balance: userBalance - 1, has_ticket: true }).eq('telegram_id', user.id);
            location.href = "dashboard.html";
        }

        init();
    </script>
</body>
</html>
