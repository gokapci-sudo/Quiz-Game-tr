<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src='//libtl.com/sdk.js' data-zone='10527452' data-sdk='show_10527452'></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <header><button onclick="location.href='dashboard.html'" class="btn-sub" style="width:auto; padding:10px 20px;">â¬… Geri</button></header>
        <div class="card" style="text-align:center;"><div style="font-size:40px;">ðŸŽ«</div><h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2></div>
        
        <div class="card" style="border:1px dashed var(--accent);">
            <h3>ðŸ“º Reklam Ä°zle (Kalan: <span id="ad-count">5</span>)</h3>
            <button id="ad-btn" onclick="watchAd()" class="btn-main" style="margin-top:10px;">REKLAM Ä°ZLE</button>
        </div>

        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <span>Bakiyenle Al (1.00 TON):</span>
            <button onclick="buyTicket()" style="background:var(--yellow); color:black; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">SATIN AL</button>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        let ads = parseInt(localStorage.getItem('ads_done')) || 0;
        document.getElementById('ad-count').innerText = 5 - ads;

        function watchAd() {
            if(typeof show_10527452 !== 'function') return tg.showAlert("Reklam hazÄ±r deÄŸil.");
            show_10527452('pop').then(() => {
                ads++; localStorage.setItem('ads_done', ads);
                document.getElementById('ad-count').innerText = 5 - ads;
                if(ads >= 5) grant();
            });
        }

        async function buyTicket() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            const { data } = await supabaseClient.from('profiles').select('balance').eq('telegram_id', user.id).single();
            if(data && data.balance >= 1.0) {
                await supabaseClient.from('profiles').update({ balance: data.balance - 1 }).eq('telegram_id', user.id);
                grant();
            } else tg.showAlert("Bakiye Yetersiz!");
        }

        async function grant() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            await supabaseClient.from('profiles').update({ has_ticket: true }).eq('telegram_id', user.id);
            localStorage.removeItem('ads_done');
            tg.showAlert("Bilet TanÄ±mlandÄ±!"); location.href="dashboard.html";
        }
    </script>
</body>
</html>
