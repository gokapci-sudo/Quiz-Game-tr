<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilet Al - Quiz Arena</title>
    <link rel="stylesheet" href="style.css">
    
    <script src='//libtl.com/sdk.js' data-zone='10527453' data-sdk='show_10527453'></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <header style="margin-bottom: 20px;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width: auto; padding: 10px 20px;">â¬… Geri DÃ¶n</button>
        </header>

        <div class="card" style="text-align: center; border: 1px solid var(--yellow);">
            <div style="font-size: 40px;">ðŸŽ«</div>
            <h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2>
            <p style="font-size: 13px; opacity: 0.8; margin-top: 5px;">YarÄ±ÅŸmaya katÄ±lmak iÃ§in bir yÃ¶ntem seÃ§in.</p>
        </div>

        <div class="card">
            <h3 style="font-size: 16px; margin-bottom: 10px;">ðŸš€ HÄ±zlÄ± KatÄ±lÄ±m</h3>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Bilet Ãœcreti:</span>
                <b class="yellow-text">1.00 TON</b>
            </div>
            <button id="buy-btn" class="btn-main" onclick="buyTicket()">HEMEN SATIN AL</button>
        </div>

        <div class="card" style="border: 1px dashed var(--accent);">
            <h3 style="font-size: 16px; margin-bottom: 10px;">ðŸ“º Ãœcretsiz Bilet</h3>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px;">5 reklam izleyerek biletinizi Ã¼cretsiz alabilirsiniz.</p>
            
            <div id="ad-progress-container" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span>Ä°zlenen Reklam</span>
                    <span id="ad-count-text">0 / 5</span>
                </div>
                <div style="width: 100%; height: 8px; background: #0e1621; border-radius: 4px; overflow: hidden;">
                    <div id="ad-bar" style="width: 0%; height: 100%; background: var(--accent); transition: 0.3s;"></div>
                </div>
            </div>

            <button id="ad-btn" class="btn-sub" style="background: var(--accent);" onclick="watchAd()">REKLAM Ä°ZLE (+1)</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;
        const MY_ID = 1369398784;

        let watchedAds = parseInt(localStorage.getItem('ad_progress')) || 0;
        let userBalance = 0;

        async function init() {
            tg.ready();
            updateAdUI();
            const user = tg.initDataUnsafe?.user || { id: MY_ID };
            
            const { data } = await supabaseClient.from('profiles').select('*').eq('telegram_id', user.id).single();
            if (data) {
                userBalance = parseFloat(data.balance || 0);
                if (data.has_ticket) {
                    showSuccessState();
                }
            }
        }

        function watchAd() {
            const btn = document.getElementById('ad-btn');
            btn.disabled = true;
            btn.innerText = "â³ Reklam HazÄ±rlanÄ±yor...";

            // Monetag Fonksiyonu (SDK'dan gelir)
            show_10527453('pop').then(() => {
                watchedAds++;
                updateAdUI();
                btn.disabled = false;
                btn.innerText = "REKLAM Ä°ZLE (+1)";

                if (watchedAds >= 5) {
                    grantFreeTicket();
                } else {
                    tg.showAlert(`Reklam baÅŸarÄ±yla izlendi! (${watchedAds}/5)`);
                }
            }).catch(e => {
                tg.showAlert("Reklam ÅŸu an yÃ¼klenemedi, lÃ¼tfen tekrar deneyin.");
                btn.disabled = false;
                btn.innerText = "REKLAM Ä°ZLE (+1)";
                console.error("Ad Error:", e);
            });
        }

        function updateAdUI() {
            const percent = (watchedAds / 5) * 100;
            document.getElementById('ad-bar').style.width = percent + "%";
            document.getElementById('ad-count-text').innerText = `${watchedAds} / 5`;
            localStorage.setItem('ad_progress', watchedAds);
        }

        async function grantFreeTicket() {
            const user = tg.initDataUnsafe?.user || { id: MY_ID };
            const { error } = await supabaseClient.from('profiles').update({ has_ticket: true }).eq('telegram_id', user.id);
            if (!error) {
                localStorage.removeItem('ad_progress');
                tg.showAlert("Tebrikler! Ãœcretsiz biletiniz tanÄ±mlandÄ±.");
                location.href = "dashboard.html";
            }
        }

        async function buyTicket() {
            if (userBalance < 1) {
                tg.showAlert("Yetersiz bakiye! LÃ¼tfen reklam izleyerek Ã¼cretsiz bilet kazanÄ±n.");
                return;
            }
            const user = tg.initDataUnsafe?.user || { id: MY_ID };
            const { error } = await supabaseClient.from('profiles').update({ 
                balance: userBalance - 1, 
                has_ticket: true 
            }).eq('telegram_id', user.id);

            if (!error) {
                tg.showAlert("Biletiniz baÅŸarÄ±yla alÄ±ndÄ±!");
                location.href = "dashboard.html";
            }
        }

        function showSuccessState() {
            document.querySelector('.container').innerHTML = `
                <div class="card" style="text-align:center; margin-top:50px;">
                    <div style="font-size:50px;">âœ…</div>
                    <h3 style="margin:15px 0;">Biletiniz Aktif!</h3>
                    <p style="opacity:0.7; font-size:14px; margin-bottom:20px;">SÄ±radaki yarÄ±ÅŸmaya katÄ±lmaya hazÄ±rsÄ±nÄ±z.</p>
                    <button onclick="location.href='dashboard.html'" class="btn-main">Panel'e DÃ¶n</button>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
