<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bilet Al - Quiz Arena</title>
    <link rel="stylesheet" href="style.css">
    
    <script src='//libtl.com/sdk.js' data-zone='10527453' data-sdk='show_10527453'></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <header style="margin-bottom: 20px; width: 100%;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width: auto; padding: 10px 20px;">â¬… Geri DÃ¶n</button>
        </header>

        <div class="card" style="text-align: center; border: 1px solid var(--yellow);">
            <div style="font-size: 40px; margin-bottom: 10px;">ðŸŽ«</div>
            <h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2>
            <p style="font-size: 13px; opacity: 0.8; margin-top: 5px;">YarÄ±ÅŸmaya katÄ±lmak iÃ§in biletinizi edinin.</p>
        </div>

        <div class="card" style="border: 1px dashed var(--accent);">
            <h3 style="font-size: 16px; margin-bottom: 10px;">ðŸ“º Ãœcretsiz Bilet</h3>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 15px;">5 kÄ±sa reklam izleyerek biletinizi Ã¼cretsiz tanÄ±mlayÄ±n.</p>
            
            <div id="ad-progress-container" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span>Tamamlanan</span>
                    <span id="ad-count-text">0 / 5</span>
                </div>
                <div style="width: 100%; height: 10px; background: #0e1621; border-radius: 5px; overflow: hidden; border: 1px solid #242f3d;">
                    <div id="ad-bar" style="width: 0%; height: 100%; background: var(--accent); transition: 0.5s ease-in-out;"></div>
                </div>
            </div>

            <button id="ad-btn" class="btn-main" onclick="watchAd()">REKLAM Ä°ZLE (+1)</button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 14px;">Beklemek istemiyor musun?</span>
                <button id="buy-btn" onclick="buyTicket()" style="background: var(--yellow); color: black; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer;">1.00 TON</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://arumdxephyjteoypjaxh.supabase.co";
        const SB_KEY = "sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        // HafÄ±zadaki reklam durumunu al
        let watchedAds = parseInt(localStorage.getItem('ad_progress')) || 0;
        let userBalance = 0;

        async function initBilet() {
            tg.ready();
            tg.expand();
            updateAdUI();

            const user = tg.initDataUnsafe?.user || { id: 1369398784 };
            const { data } = await supabaseClient.from('profiles').select('*').eq('telegram_id', user.id).single();
            
            if (data) {
                userBalance = parseFloat(data.balance || 0);
                if (data.has_ticket) {
                    showTicketActive();
                }
            }
        }

        function updateAdUI() {
            const percent = (watchedAds / 5) * 100;
            document.getElementById('ad-bar').style.width = percent + "%";
            document.getElementById('ad-count-text').innerText = `${watchedAds} / 5`;
            localStorage.setItem('ad_progress', watchedAds);
        }

        function watchAd() {
            const btn = document.getElementById('ad-btn');
            
            // SDK ve Fonksiyon KontrolÃ¼
            if (typeof show_10527453 !== 'function') {
                tg.showAlert("Reklam servisi yÃ¼kleniyor, lÃ¼tfen 3 saniye sonra tekrar basÄ±n.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "â³ Reklam YÃ¼kleniyor...";

            // Monetag Rewarded Call
            show_10527453('pop').then(() => {
                watchedAds++;
                updateAdUI();
                
                if (watchedAds >= 5) {
                    grantFreeTicket();
                } else {
                    tg.showAlert(`Reklam baÅŸarÄ±yla izlendi! (${watchedAds}/5)`);
                    resetButton();
                }
            }).catch(e => {
                tg.showAlert("Reklam ÅŸu an hazÄ±r deÄŸil. LÃ¼tfen biraz bekleyip tekrar deneyin.");
                resetButton();
                console.error("Monetag Error:", e);
            });
        }

        function resetButton() {
            const btn = document.getElementById('ad-btn');
            btn.disabled = false;
            btn.innerText = "REKLAM Ä°ZLE (+1)";
        }

        async function grantFreeTicket() {
            const user = tg.initDataUnsafe?.user || { id: 1369398784 };
            const { error } = await supabaseClient.from('profiles').update({ has_ticket: true }).eq('telegram_id', user.id);
            
            if (!error) {
                localStorage.removeItem('ad_progress');
                tg.showPopup({
                    title: 'Tebrikler!',
                    message: '5 reklam izleyerek Ã¼cretsiz biletinizi kazandÄ±nÄ±z!',
                    buttons: [{type: 'ok'}]
                }, () => {
                    window.location.href = "dashboard.html";
                });
            }
        }

        async function buyTicket() {
            if (userBalance < 1) {
                tg.showAlert("Bakiyeniz yetersiz (1.00 TON gerekli). Reklam izleyerek bilet alabilirsiniz.");
                return;
            }
            const user = tg.initDataUnsafe?.user || { id: 1369398784 };
            await supabaseClient.from('profiles').update({ balance: userBalance - 1, has_ticket: true }).eq('telegram_id', user.id);
            window.location.href = "dashboard.html";
        }

        function showTicketActive() {
            document.querySelector('.container').innerHTML = `
                <div class="card" style="text-align:center; margin-top:50px; padding:40px 20px;">
                    <div style="font-size:60px;">âœ…</div>
                    <h2 style="margin:20px 0;">Biletiniz Aktif</h2>
                    <p style="opacity:0.7; margin-bottom:30px;">SÄ±radaki yarÄ±ÅŸmaya giriÅŸ yapabilirsiniz.</p>
                    <button onclick="location.href='dashboard.html'" class="btn-main">Panele DÃ¶n</button>
                </div>
            `;
        }

        initBilet();
    </script>
</body>
</html>
