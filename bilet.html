<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src='//libtl.com/sdk.js' data-zone='10527452' data-sdk='show_10527452'></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <header style="padding: 10px 0;">
            <button onclick="location.href='dashboard.html'" class="btn-sub" style="width:auto; padding:10px 20px;">â¬… Geri DÃ¶n</button>
        </header>

        <div class="card" style="text-align:center;">
            <div style="font-size:50px; margin-bottom:10px;">ðŸŽ«</div>
            <h2 class="yellow-text">BÄ°LET MERKEZÄ°</h2>
            <p style="opacity:0.7; font-size:13px;">GÃ¶revleri tamamlayarak veya bakiye ile bilet alabilirsiniz.</p>
        </div>
        
        <div class="card" style="border: 2px dashed var(--accent);">
            <h3 style="margin-bottom:10px;">ðŸ“º Ãœcretsiz Bilet</h3>
            <p id="status-text" style="margin-bottom:15px;">Ä°zlenen Reklam: <b id="count" class="yellow-text">0</b> / 5</p>
            <button id="ad-btn" onclick="watchAd()" class="btn-main">REKLAM Ä°ZLE</button>
        </div>

        <div class="card">
            <h3>ðŸ’° Bakiye Ä°le Al</h3>
            <p style="opacity:0.7; font-size:12px; margin-bottom:10px;">Bakiyenizden 0.10 TON dÃ¼ÅŸÃ¼lÃ¼r.</p>
            <button onclick="buyTicket()" class="btn-main" style="background:var(--accent);">0.10 TON Ä°LE SATIN AL</button>
        </div>

        <div class="card" style="border: 1px solid #2481cc; background: rgba(36, 129, 204, 0.05);">
            <h3>ðŸ‘¥ ArkadaÅŸÄ±nÄ± Davet Et</h3>
            <p style="opacity:0.7; font-size:12px; margin-bottom:10px;">5 arkadaÅŸÄ±nÄ± getir, anÄ±nda 1 bilet kazan!</p>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: center;">
                <span style="font-size: 11px; opacity: 0.6; display: block;">Kabul Edilen Davet</span>
                <b id="ref-count" style="font-size: 18px; color: #2481cc;">0 / 5</b>
            </div>
            <button onclick="inviteFriend()" class="btn-main" style="background: #2481cc;">ARKADAÅžINI DAVET ET</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let adCount = parseInt(localStorage.getItem('quiz_ads_watched')) || 0;
        document.getElementById('count').innerText = adCount;

        async function initPage() {
            loadReferralProgress();
        }

        async function loadReferralProgress() {
            const user = tg.initDataUnsafe?.user || { id: 0 };
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('referral_count')
                .eq('telegram_id', user.id)
                .single();

            if (!error && data) {
                document.getElementById('ref-count').innerText = `${data.referral_count} / 5`;
            }
        }

        function inviteFriend() {
            const user = tg.initDataUnsafe?.user;
            if (!user) return;

            // Ã–NEMLÄ°: 'BotunuzunUsernami/OyunAdin' kÄ±smÄ±nÄ± kendi Telegram Web App linkinle deÄŸiÅŸtir
            // Ã–rn: MyQuizBot/play
            const webAppUrl = "SkillSurviveGameBot/play"; 
            const inviteLink = `https://t.me/${webAppUrl}?startapp=${user.id}`;
            const shareText = "Hey! Bu bilgi yarÄ±ÅŸmasÄ±nda TON kazanÄ±yorum. Gel birlikte yarÄ±ÅŸalÄ±m! ðŸ†";
            
            const fullUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(shareText)}`;
            tg.openTelegramLink(fullUrl);
        }

        function watchAd() {
            if (typeof show_10527452 !== 'function') {
                tg.showAlert("Reklam henÃ¼z hazÄ±r deÄŸil.");
                return;
            }
            const btn = document.getElementById('ad-btn');
            btn.disabled = true;
            btn.innerText = "YÃœKLENÄ°YOR...";

            show_10527452('pop').then(() => {
                adCount++;
                localStorage.setItem('quiz_ads_watched', adCount);
                document.getElementById('count').innerText = adCount;
                btn.disabled = false;
                btn.innerText = "REKLAM Ä°ZLE";

                if (adCount >= 5) {
                    grantTicket("Reklam izleme tamamlandÄ±!");
                }
            }).catch(() => {
                btn.disabled = false;
                btn.innerText = "REKLAM Ä°ZLE";
            });
        }

        async function buyTicket() {
            const user = tg.initDataUnsafe?.user || { id: 0 };
            const { data: p } = await supabaseClient.from('profiles').select('balance').eq('telegram_id', user.id).single();

            if (p && p.balance >= 0.10) {
                const { error: upErr } = await supabaseClient.from('profiles').update({ balance: p.balance - 0.10 }).eq('telegram_id', user.id);
                if (!upErr) grantTicket("Bilet satÄ±n alÄ±ndÄ±!");
            } else {
                tg.showAlert("Bakiyeniz yetersiz.");
            }
        }

        async function grantTicket(msg) {
            const user = tg.initDataUnsafe?.user || { id: 0 };
            const { error } = await supabaseClient.from('profiles').update({ has_ticket: true }).eq('telegram_id', user.id);
            if (!error) {
                localStorage.setItem('quiz_ads_watched', 0);
                tg.showAlert(msg);
                location.href = "dashboard.html";
            }
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
