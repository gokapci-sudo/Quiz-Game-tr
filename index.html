<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quiz Arena V1.0</title>
    
    <script src='//libtl.com/sdk.js' data-zone='10527452' data-sdk='show_10527452'></script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --gold: #fbbf24; --yt: #ff0000; --success: #10b981; --error: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; text-align:center; min-height: 100vh; overflow: hidden; }
        .screen { display:none; padding: 20px; flex-direction: column; align-items: center; width: 100%; height: 100vh; overflow-y: auto; position: fixed; top:0; left:0; right: 0; }
        .screen.active { display:flex; }
        .card { background:var(--card); padding:15px; border-radius:15px; margin:10px 0; border:1px solid #334155; width: 100%; max-width: 450px; }
        .btn { display:block; width: 100%; max-width: 450px; padding:16px; border-radius:12px; border:none; font-weight:bold; cursor:pointer; margin-bottom:10px; font-size: 1rem; color: #fff; text-decoration: none; }
        .btn-blue { background:var(--primary); color:#000; }
        .btn-yt { background: var(--yt); color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-option { background: #ffffff; color: #000; margin-bottom: 12px; text-align: left; padding: 14px; border: 2px solid transparent; }
        .btn-success { background: var(--success) !important; color: #fff !important; }
        .btn-error { background: var(--error) !important; color: #fff !important; }
        .countdown-timer { font-size: 1.5rem; font-weight: bold; color: var(--gold); margin: 5px 0; font-family: monospace; }
        .sponsor-box { background: #1e293b; height: 80px; border-radius: 12px; margin-bottom: 8px; border: 1px dashed #475569; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #94a3b8; width: 100%; max-width: 450px; overflow: hidden; }
        .prize-table { background: rgba(56, 189, 248, 0.1); border: 1px solid var(--primary); border-radius: 12px; padding: 10px; width: 100%; max-width: 450px; margin-bottom: 10px; }
        .leader-row { display:flex; justify-content:space-between; padding:12px; background: rgba(30, 41, 59, 0.5); margin-bottom: 4px; border-radius: 8px; font-size: 0.85rem; }
        .winner { border: 1px solid var(--gold); background: rgba(251, 191, 36, 0.1); }
        #ton-connect-btn { display: flex; justify-content: center; width: 100%; margin: 10px 0; }
        .count-badge { background: rgba(56, 189, 248, 0.1); border: 1px solid var(--primary); padding: 10px; border-radius: 12px; margin-bottom: 10px; width: 100%; max-width: 450px; font-size: 0.9rem; font-weight: bold; }
        .grand-timer { background: linear-gradient(45deg, #1e293b, #334155); border: 2px solid var(--gold); padding: 15px; border-radius: 15px; margin-bottom: 15px; width: 100%; max-width: 450px; }
    </style>
</head>
<body>

    <div id="sponsor-screen" class="screen active">
        <h2 style="color: var(--gold); margin-bottom: 5px;">ARENA SPONSORLARI</h2>
        
        <div class="grand-timer">
            <p style="margin:0; font-size:0.7rem; color:var(--gold); font-weight:bold; letter-spacing:1px;">RESMÄ° YARIÅMANIN BAÅLAMASINA</p>
            <div id="grand-countdown" style="font-size: 1.6rem; font-weight: bold; color: #fff; margin: 8px 0; font-family: monospace;">-- GÃœN -- SAAT</div>
            <p style="margin:0; font-size:0.65rem; color:#94a3b8;">1 MART 2026</p>
        </div>

        <div id="ticket-count-area" class="count-badge" style="border-color: var(--gold); color: var(--gold); display:none;">
            ğŸ« BugÃ¼n <span id="t-count">0</span> kiÅŸi bilet aldÄ±!
        </div>

        <div id="sponsor-list" style="width:100%; display: flex; flex-direction: column; align-items: center;"></div>
        <button class="btn btn-blue" onclick="showScreen('main-screen')">GÄ°RÄ°Å YAP ğŸš€</button>
    </div>

    <div id="main-screen" class="screen">
        <div class="card"><h2 id="u-name">@Oyuncu</h2><div id="ton-connect-btn"></div></div>
        <div id="action-area" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        
        <div class="card" style="border: 2px solid var(--gold); background: linear-gradient(45deg, rgba(251, 191, 36, 0.1), transparent); margin-bottom:5px;">
            <p style="margin:0; font-size:0.65rem; color:var(--gold); font-weight:bold; letter-spacing:1px;">TOPLAM Ã–DÃœL HAVUZU</p>
            <h1 id="jackpot-amount" style="margin:5px 0; font-size:2.2rem; color:var(--gold);">... TON</h1>
        </div>

        <div class="prize-table">
            <div style="font-weight: bold; color: var(--gold); margin-bottom: 5px; font-size: 0.8rem;">ğŸ† SIRALAMA Ã–DÃœLLERÄ°</div>
            <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                <span>1.: <b id="p1">...</b></span> 
                <span>2.: <b id="p2">...</b></span> 
                <span>3.: <b id="p3">...</b></span>
            </div>
        </div>

        <button class="btn" style="background:#475569" onclick="fetchLeaderboard()">ğŸ† SIRALAMA</button>
        <button class="btn" style="background:#334155" onclick="showAnnouncements()">ğŸ“¢ DUYURULAR</button>
    </div>

    <div id="announcement-screen" class="screen">
        <h2 style="color: var(--gold)">ğŸ“¢ DUYURULAR</h2>
        <div class="card" id="announcement-text" style="line-height: 1.6; text-align: left;"></div>
        <button class="btn btn-blue" onclick="showScreen('main-screen')">ANLADIM âœ…</button>
    </div>

    <div id="task-screen" class="screen">
        <h2 style="color: var(--gold)">BÄ°LET AL</h2>
        <div class="card" style="border: 2px solid var(--primary); background: rgba(56, 189, 248, 0.05);">
            <p style="margin:0; font-weight:bold; color:var(--primary);">HÄ±zlÄ± GiriÅŸ âš¡</p>
            <p style="font-size:0.75rem; margin:5px 0;">0.1 TON ile bilet al.</p>
            <button class="btn btn-blue" onclick="buyTicketWithTON()" style="margin-top:5px; padding:12px;">0.1 TON Ä°LE SATIN AL</button>
        </div>
        <div style="margin: 5px 0; font-size: 0.7rem; color: #64748b;">â€” VEYA â€”</div>
        <div class="card" style="border: 2px solid var(--success); background: rgba(16, 185, 129, 0.05);">
            <p style="margin:0; font-weight:bold; color:var(--success);">Ãœcretsiz Bilet Paketi ğŸ¬</p>
            <p style="font-size:0.8rem; margin:10px 0;">YarÄ±ÅŸma iÃ§in <b>4 reklam</b> izlemelisiniz.</p>
            <button id="ad-btn" class="btn btn-yt" style="background: var(--success);" onclick="watchAd()">
                ğŸ¬ REKLAM Ä°ZLE (0/4)
            </button>
        </div>
        <button class="btn" style="background:#475569" onclick="showScreen('main-screen')">â¬…ï¸ GERÄ°</button>
    </div>

    <div id="quiz-screen" class="screen"><div id="quiz-timer" style="font-size:2.5rem; color:var(--gold); font-weight:800; margin:15px 0;">15</div><div class="card"><h3 id="question-text">...</h3></div><div id="options-container" style="width:100%"></div></div>
    <div id="result-screen" class="screen"><h2 style="color: var(--gold)">BÄ°TTÄ°!</h2><div class="card"><h1 id="final-score" style="font-size:3rem; color:var(--primary)">0</h1></div><button class="btn btn-blue" onclick="location.reload()">TAMAM</button></div>
    
    <div id="leader-screen" class="screen">
        <h2 style="color: var(--gold)">ğŸ† SIRALAMA</h2>
        <div id="player-count-area" class="count-badge" style="display:none;">
            ğŸ‘¥ BugÃ¼n yarÄ±ÅŸan kiÅŸi sayÄ±sÄ±: <span id="p-count">0</span>
        </div>
        <div id="leader-list" style="width:100%"></div>
        <button class="btn btn-blue" onclick="showScreen('main-screen')">GERÄ°</button>
    </div>

    <script>
        const SB_URL = 'https://arumdxephyjteoypjaxh.supabase.co';
        const SB_KEY = 'sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1';
        const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        let userId = tg.initDataUnsafe?.user?.id || 123456, user = null;
        let adCount = 0;
        let dailyQuestions = [], currentIdx = 0, score = 0, timer, timeLeft = 15, quizStartTime = 0;

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://gokapci-sudo.github.io/Quiz-Game-tr/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        function watchAd() {
            show_10527452('pop').then(() => {
                adCount++;
                document.getElementById('ad-btn').innerText = `ğŸ¬ REKLAM Ä°ZLE (${adCount}/4)`;
                if (adCount >= 4) { completeAdTask(); }
                else { tg.showAlert(`Reklam izlendi! Kalan: ${4 - adCount}`); }
            }).catch(() => { tg.showAlert("Reklam ÅŸu an hazÄ±r deÄŸil."); });
        }

        async function completeAdTask() {
            const { error } = await _supabase.from('users').update({ has_ticket: true }).eq('telegram_id', userId);
            if (!error) { user.has_ticket = true; adCount = 0; tg.showAlert("Tebrikler! Biletiniz tanÄ±mlandÄ±. ğŸ«"); updateTicketCount(); showScreen('main-screen'); }
        }

        async function init() {
            tg.ready(); tg.expand();
            if (typeof show_10527452 === 'function') {
                show_10527452('pop').then(() => { showScreen('main-screen'); }).catch(() => { console.log("Otomatik reklam yÃ¼klenemedi."); });
            }
            if (typeof updatePrizesAndJackpot === "function") await updatePrizesAndJackpot();
            const sList = document.getElementById('sponsor-list');
            if (sList) {
                sList.innerHTML = APP_CONFIG.sponsors.map(s => `<div class="sponsor-box">${s.img ? `<img src="${s.img}" style="width:100%; height:100%; object-fit: cover;">` : s.text}</div>`).join("");
            }
            const { data } = await _supabase.from('users').select('*').eq('telegram_id', userId).maybeSingle();
            user = data || (await _supabase.from('users').insert([{ telegram_id: userId, username: tg.initDataUnsafe?.user?.username || "Oyuncu", has_ticket: false }]).select().single()).data;
            
            updateTicketCount();
            setInterval(renderMain, 1000);
            // 1 MART GERÄ° SAYIMINI BAÅLAT
            setInterval(updateGrandCountdown, 1000);
            updateGrandCountdown();
        }

        function updateGrandCountdown() {
            const target = new Date("March 1, 2026 00:00:00").getTime();
            const now = new Date().getTime();
            const diff = target - now;
            if (diff <= 0) {
                document.getElementById("grand-countdown").innerText = "YARIÅMA BAÅLADI!";
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById("grand-countdown").innerText = `${d}G ${h}S ${m}D ${s}S`;
        }

        async function updateTicketCount() {
            const { count } = await _supabase.from('users').select('*', { count: 'exact', head: true }).eq('has_ticket', true);
            if (count !== null) { document.getElementById('t-count').innerText = count; document.getElementById('ticket-count-area').style.display = 'block'; }
        }

        function getTRTime() { return new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Istanbul"})); }

        function renderMain() {
            if (!user) return;
            const now = getTRTime();
            const { hour, minute, durationMinutes } = APP_CONFIG.matchTime;
            const isMatchTime = (now.getHours() === hour && now.getMinutes() >= minute && now.getMinutes() < minute + durationMinutes);
            const actionArea = document.getElementById('action-area');
            document.getElementById('u-name').innerText = `@${user.username}`;
            let target = getTRTime(); target.setHours(hour, minute, 0, 0);
            if (now >= target && !isMatchTime) target.setDate(target.getDate() + 1);
            let diff = target - now; if (diff < 0) diff = 0; 
            let dh = Math.floor(diff/3600000).toString().padStart(2,'0'), dm = Math.floor((diff%3600000)/60000).toString().padStart(2,'0'), ds = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
            const countdownHTML = `<p style="margin-bottom:0; font-size:0.8rem; color:#94a3b8;">SÄ±radaki yarÄ±ÅŸma:</p><div class="countdown-timer">${dh}:${dm}:${ds}</div>`;
            if (user.last_played_date === now.toISOString().split('T')[0]) {
                actionArea.innerHTML = `<div class="card"><p style="color:var(--primary); font-weight:bold; margin-top:0;">YarÄ±n tekrar gel!</p>${countdownHTML}</div>`;
            } else if (isMatchTime) {
                actionArea.innerHTML = user.has_ticket ? `<button class="btn btn-blue" onclick="startQuiz()">ğŸš€ BAÅLAT</button>` : `<button class="btn btn-yt" onclick="showScreen('task-screen')">ğŸ« BÄ°LET AL</button>`;
            } else {
                actionArea.innerHTML = `<div class="card">${countdownHTML}${!user.has_ticket ? '<button class="btn btn-yt" onclick="showScreen(\'task-screen\')">ğŸ« BÄ°LET AL</button>' : '<p style="color:var(--success); font-weight:bold; font-size:0.8rem;">ğŸ« Biletiniz HazÄ±r!</p>'}</div>`;
            }
        }

        async function buyTicketWithTON() {
            const transaction = { validUntil: Math.floor(Date.now()/1000)+600, messages: [{ address: "UQAhiYJQNPQmh1J_Jvnlw3kdL8Q6rK0_2LbjXY_CLfMQGVb5", amount: "100000000" }] };
            try { if (!tonConnectUI.connected) { await tonConnectUI.openModal(); return; } const result = await tonConnectUI.sendTransaction(transaction); if (result) { await _supabase.from('users').update({ has_ticket: true }).eq('telegram_id', userId); user.has_ticket = true; updateTicketCount(); tg.showAlert("Bilet alÄ±ndÄ±!"); showScreen('main-screen'); } } catch (e) { tg.showAlert("Ä°ptal edildi."); }
        }

        function startQuiz() { const todaySeed = getTRTime().toISOString().split('T')[0]; const seededShuffle = (array, seed) => { let m = array.length, t, i, sNum = seed.split('-').reduce((a, c) => a + parseInt(c), 0); while (m) { i = Math.floor((Math.abs(Math.sin(sNum++)) * 10000) % m--); t = array[m]; array[m] = array[i]; array[i] = t; } return array; }; dailyQuestions = seededShuffle([...APP_CONFIG.questions], todaySeed).slice(0, 10); currentIdx = 0; score = 0; quizStartTime = Date.now(); showScreen('quiz-screen'); loadQuestion(); }
        function loadQuestion() { if (currentIdx >= dailyQuestions.length) return endQuiz(); timeLeft = 15; document.getElementById('quiz-timer').innerText = timeLeft; const q = dailyQuestions[currentIdx]; document.getElementById('question-text').innerText = q.question; const container = document.getElementById('options-container'); container.innerHTML = ''; q.options.forEach((opt, i) => { const b = document.createElement('button'); b.className = 'btn btn-option'; b.innerText = opt; b.onclick = () => { clearInterval(timer); if(i === q.correct_option) { b.classList.add('btn-success'); score += timeLeft * 10; } else { b.classList.add('btn-error'); document.querySelectorAll('.btn-option')[q.correct_option].classList.add('btn-success'); } setTimeout(() => { currentIdx++; loadQuestion(); }, 1200); }; container.appendChild(b); }); if(timer) clearInterval(timer); timer = setInterval(() => { timeLeft--; document.getElementById('quiz-timer').innerText = timeLeft; if(timeLeft <= 0) { clearInterval(timer); currentIdx++; loadQuestion(); }}, 1000); }
        async function endQuiz() { const timeMs = Date.now() - quizStartTime, today = getTRTime().toISOString().split('T')[0]; document.getElementById('final-score').innerText = score; showScreen('result-screen'); await _supabase.from('daily_scores').insert([{ telegram_id: userId, username: user.username, score: score, completion_time: timeMs, play_date: today }]); await _supabase.from('users').update({ last_played_date: today, has_ticket: false }).eq('telegram_id', userId); }
        async function fetchLeaderboard() { const today = getTRTime().toISOString().split('T')[0]; const { data, count } = await _supabase.from('daily_scores').select('*', { count: 'exact' }).eq('play_date', today).order('score', {ascending: false}).order('completion_time', {ascending: true}); if (count !== null) { document.getElementById('p-count').innerText = count; document.getElementById('player-count-area').style.display = 'block'; } let html = data?.length ? data.map((r, i) => `<div class="leader-row ${i < 3 ? 'winner' : ''}"><span><b>#${i+1}</b> @${r.username}</span><span><b>${r.score} P</b> <small>${(r.completion_time/1000).toFixed(1)}s</small></span></div>`).join("") : "<p>HenÃ¼z katÄ±lÄ±m yok.</p>"; document.getElementById('leader-list').innerHTML = html; showScreen('leader-screen'); }
        function showAnnouncements() { document.getElementById('announcement-text').innerText = APP_CONFIG.announcement; showScreen('announcement-screen'); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        window.onload = init;
    </script>
</body>
</html>
