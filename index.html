<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Arena Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --error: #ef4444; --gold: #fbbf24; }
        body { margin:0; background: var(--bg); color: var(--text); font-family: sans-serif; text-align:center; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
        .screen { display:none; padding: 20px; flex: 1; flex-direction: column; align-items: center; justify-content: flex-start; }
        .screen.active { display:flex !important; }
        .card { background:var(--card); padding:20px; border-radius:15px; margin:10px 0; border:1px solid #334155; width: 90%; max-width: 400px; }
        .btn { display:block; width: 100%; padding:14px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; margin-bottom:10px; font-size: 1rem; color: #fff; transition: 0.2s; }
        .btn-blue { background:var(--primary); color:#000; }
        .btn-option { background: #334155; text-align: left; }
        .btn-option.selected { background: var(--primary); color: #000; }
        
        /* Leaderboard */
        .leader-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        .leader-row:last-child { border: none; }
        .rank { font-weight: bold; color: var(--gold); margin-right: 10px; }

        /* Review List */
        .review-item { text-align: left; border-bottom: 1px solid #475569; padding: 10px 0; font-size: 0.85rem; }
        .review-q { font-weight: bold; margin-bottom: 5px; }
        .review-a { color: var(--success); }
        .review-your { color: var(--error); }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active">
        <p>Arena HazÄ±rlanÄ±yor...</p>
    </div>

    <div id="main-screen" class="screen">
        <div class="card">
            <h2 id="u-name">@Oyuncu</h2>
            <p id="entry-status">YarÄ±ÅŸma Durumu: Kontrol Ediliyor...</p>
        </div>
        <button id="start-btn" class="btn btn-blue" style="display:none;" onclick="startQuiz()">ğŸš€ YARIÅMAYA GÄ°R</button>
        <button class="btn" style="background:#475569" onclick="fetchLeaderboard()">ğŸ† LÄ°DERLÄ°K TABLOSU</button>
    </div>

    <div id="quiz-screen" class="screen">
        <div id="quiz-timer" style="font-size: 1.5rem; color: var(--gold); font-weight: bold;">15</div>
        <div class="card"><h3 id="question-text">...</h3></div>
        <div id="options-container" style="width: 100%; max-width: 400px;"></div>
    </div>

    <div id="result-screen" class="screen">
        <div class="card">
            <h2>Puan: <span id="final-score" style="color:var(--primary)">0</span></h2>
            <p>BugÃ¼nkÃ¼ yarÄ±ÅŸmayÄ± tamamladÄ±n!</p>
        </div>
        
        <div class="card" style="background: transparent;">
            <h3>CevaplarÄ±nÄ±zÄ± Ä°nceleyin</h3>
            <div id="review-list"></div>
        </div>
        <button class="btn btn-blue" onclick="location.reload()">ğŸ”„ ANA SAYFAYA DÃ–N</button>
    </div>

    <div id="leader-screen" class="screen">
        <div class="card" style="width: 95%;">
            <h3>ğŸ† GÃ¼nÃ¼n En Ä°yileri</h3>
            <div id="leader-list"></div>
        </div>
        <button class="btn btn-blue" onclick="showScreen('main-screen')">â¬…ï¸ GERÄ° DÃ–N</button>
    </div>

    <script>
        const SB_URL = 'https://arumdxephyjteoypjaxh.supabase.co';
        const SB_KEY = 'sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1';
        const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id || 123456;

        const questions = [
            { q: "TON hangi aÄŸÄ±n kripto parasÄ±dÄ±r?", a: ["The Open Network", "Ethereum", "Solana", "Bitcoin"], c: 0 },
            { q: "Telegram'Ä±n kurucusu kimdir?", a: ["Mark Zuckerberg", "Pavel Durov", "Elon Musk", "Bill Gates"], c: 1 },
            { q: "1 TON yaklaÅŸÄ±k kaÃ§ dolardÄ±r?", a: ["1$", "5$", "50$", "100$"], c: 1 },
            { q: "Blockchain'de bloklar nasÄ±l baÄŸlanÄ±r?", a: ["Zincir", "Hash DeÄŸeri", "Wifi", "Kablo"], c: 1 },
            { q: "Hangisi soÄŸuk cÃ¼zdandÄ±r?", a: ["Borsa", "Ledger", "Website", "Instagram"], c: 1 }
        ];

        let currentIdx = 0, score = 0, timer, timeLeft = 15;
        let userAnswers = []; // KullanÄ±cÄ±nÄ±n seÃ§imlerini tutar
        let user = null;

        async function init() {
            tg.expand();
            const { data } = await _supabase.from('users').select('*').eq('telegram_id', userId).maybeSingle();
            user = data;
            document.getElementById('u-name').innerText = `@${user.username}`;
            
            // GÃ¼nlÃ¼k GiriÅŸ KontrolÃ¼
            const today = new Date().toISOString().split('T')[0];
            if (user.last_played_date === today) {
                document.getElementById('entry-status').innerText = "YarÄ±ÅŸma: BugÃ¼n tamamlandÄ± ğŸ";
                document.getElementById('start-btn').style.display = 'none';
            } else {
                document.getElementById('entry-status').innerText = "YarÄ±ÅŸma: HazÄ±r ğŸš€";
                document.getElementById('start-btn').style.display = 'block';
            }
            showScreen('main-screen');
        }

        function startQuiz() {
            userAnswers = []; score = 0; currentIdx = 0;
            showScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= questions.length) return endQuiz();
            timeLeft = 15;
            document.getElementById('quiz-timer').innerText = timeLeft;
            const qData = questions[currentIdx];
            document.getElementById('question-text').innerText = qData.q;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            qData.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.innerText = opt;
                btn.onclick = () => selectOption(i, btn);
                container.appendChild(btn);
            });
            startTimer();
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('quiz-timer').innerText = timeLeft;
                if (timeLeft <= 0) selectOption(-1); 
            }, 1000);
        }

        function selectOption(idx, btn) {
            clearInterval(timer);
            if(btn) btn.classList.add('selected');
            
            // CevabÄ± kaydet ama sonucu gÃ¶sterme!
            userAnswers.push(idx);
            if (idx === questions[currentIdx].c) {
                score += (timeLeft * 10);
            }
            
            setTimeout(() => {
                currentIdx++;
                loadQuestion();
            }, 500);
        }

        async function endQuiz() {
            showScreen('result-screen');
            document.getElementById('final-score').innerText = score;
            
            // YarÄ±ÅŸma analizini oluÅŸtur
            const reviewContainer = document.getElementById('review-list');
            reviewContainer.innerHTML = '';
            questions.forEach((q, i) => {
                const userChoice = userAnswers[i];
                const isCorrect = userChoice === q.c;
                reviewContainer.innerHTML += `
                    <div class="review-item">
                        <div class="review-q">${i+1}. ${q.q}</div>
                        <div class="review-a">âœ… DoÄŸru: ${q.a[q.c]}</div>
                        ${!isCorrect ? `<div class="review-your">âŒ Sizin: ${userChoice === -1 ? 'SÃ¼re Bitti' : q.a[userChoice]}</div>` : ''}
                    </div>`;
            });

            // VeritabanÄ±nÄ± GÃ¼ncelle (Kilit koy)
            const today = new Date().toISOString().split('T')[0];
            await _supabase.from('users').update({ last_played_date: today }).eq('telegram_id', userId);
            await _supabase.from('daily_scores').insert([{
                telegram_id: userId, username: user.username, score: score, play_date: today
            }]);
        }

        async function fetchLeaderboard() {
            showScreen('leader-screen');
            const today = new Date().toISOString().split('T')[0];
            const { data } = await _supabase.from('daily_scores')
                .select('*')
                .eq('play_date', today)
                .order('score', { ascending: false })
                .limit(10);

            const list = document.getElementById('leader-list');
            list.innerHTML = data && data.length > 0 ? "" : "HenÃ¼z veri yok.";
            data.forEach((row, i) => {
                list.innerHTML += `
                    <div class="leader-row">
                        <span><span class="rank">#${i+1}</span> @${row.username}</span>
                        <span style="font-weight:bold">${row.score} Puan</span>
                    </div>`;
            });
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
