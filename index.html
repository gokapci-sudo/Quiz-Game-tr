<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skill Survive: 456</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; }
        #game-ui {
            position: absolute;
            top: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
            display: flex; flex-direction: column; align-items: center;
        }
        .header {
            margin-top: 40px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff0055;
            border-radius: 10px;
            color: #ff0055;
            font-family: 'Roboto Mono', monospace;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.3);
        }
        #status-indicator {
            position: absolute;
            top: 50%; transform: translateY(-50%);
            font-size: 5rem;
            font-family: 'Roboto Mono', monospace;
            opacity: 0;
            transition: all 0.1s ease-out;
        }
        .show-status { opacity: 1 !important; transform: translateY(-50%) scale(1.2) !important; }
    </style>
</head>
<body>
    <div id="game-ui">
        <div class="header">PLAYER 456 | <span id="timer">00.00s</span></div>
        <div id="status-indicator">DUR!</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: document.body,
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let player, doll, gameStatus = 'WAITING', isMoving = false;
        let startTime, elapsedTime = 0;

        function preload() {
            // Görsel olarak daha zengin placeholderlar
            this.load.image('bg', 'https://i.imgur.com/8N8yQy9.jpeg'); // Labirent Merdivenler
            this.load.image('doll', 'https://i.imgur.com/gK9pD3r.png');
            this.load.spritesheet('dude', 'https://labs.phaser.io/assets/sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
        }

        function create() {
            // Arka Planı kapla
            let bg = this.add.image(config.width/2, config.height/2, 'bg');
            bg.setDisplaySize(config.width, config.height);
            bg.setAlpha(0.6);

            // Bitiş Hattı - Neon Pembe
            let line = this.add.graphics();
            line.lineStyle(5, 0xff0055, 1);
            line.strokeLineShape(new Phaser.Geom.Line(0, 150, config.width, 150));
            line.setPostPipeline(new Phaser.Renderer.WebGL.Pipelines.FX.GlowFX());

            // Bebek
            doll = this.add.sprite(config.width/2, 80, 'doll').setScale(0.5);

            // Oyuncu ve Animasyonlar
            player = this.add.sprite(config.width/2, config.height - 100, 'dude').setScale(2);
            
            this.anims.create({
                key: 'run',
                frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                frameRate: 10,
                repeat: -1
            });

            // Girdi Kontrolleri
            this.input.on('pointerdown', () => {
                if(gameStatus === 'WAITING') {
                    gameStatus = 'GREEN';
                    startTime = Date.now();
                    cycleLights();
                }
                if(gameStatus !== 'ELIMINATED') isMoving = true;
            });
            this.input.on('pointerup', () => { isMoving = false; player.anims.stop(); player.setFrame(4); });
        }

        function cycleLights() {
            if(gameStatus === 'ELIMINATED' || gameStatus === 'WIN') return;

            const indicator = document.getElementById('status-indicator');
            gameStatus = (gameStatus === 'GREEN') ? 'RED' : 'GREEN';

            if(gameStatus === 'RED') {
                indicator.innerText = "DUR!";
                indicator.style.color = "#ff0055";
                indicator.classList.add('show-status');
                this.cameras.main.shake(200, 0.005);
                doll.setTint(0xff0000);
            } else {
                indicator.innerText = "KOŞ!";
                indicator.style.color = "#00ffcc";
                indicator.classList.add('show-status');
                doll.clearTint();
            }

            setTimeout(() => indicator.classList.remove('show-status'), 800);
            
            let nextChange = gameStatus === 'GREEN' ? 2000 + Math.random() * 3000 : 1500 + Math.random() * 1000;
            setTimeout(() => cycleLights.call(this), nextChange);
        }

        function update() {
            if(gameStatus === 'WAITING' || gameStatus === 'ELIMINATED' || gameStatus === 'WIN') return;

            elapsedTime = ((Date.now() - startTime) / 1000).toFixed(2);
            document.getElementById('timer').innerText = elapsedTime + "s";

            if(isMoving) {
                player.y -= 3.5;
                if(!player.anims.isPlaying) player.play('run');

                if(gameStatus === 'RED') {
                    gameStatus = 'ELIMINATED';
                    player.setTint(0xff0000);
                    this.add.text(config.width/2, config.height/2, 'ELENDİN', { fontSize: '64px', fill: '#ff0055' }).setOrigin(0.5);
                }
            }

            if(player.y < 150) {
                gameStatus = 'WIN';
                tg.showAlert("Hayatta kaldın! Süre: " + elapsedTime);
            }
        }
    </script>
</body>
</html>
