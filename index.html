<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Master Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/adsgram-ad-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; text-align: center; }
        #app { padding: 20px; max-width: 500px; margin: auto; }
        .screen { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #334155; margin: 20px 0; }
        .btn { display: block; width: 100%; padding: 16px; margin: 10px 0; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-ad { background: #f59e0b; color: #000; }
        .btn-play { background: var(--accent); color: #000; }
        .option { background: #334155; color: white; text-align: left; }
        #timer { font-size: 2.5rem; color: var(--accent); font-weight: 800; margin: 10px 0; }
        .review-card { text-align: left; border-left: 4px solid #334155; padding-left: 15px; margin-bottom: 10px; font-size: 0.9rem; }
        .correct { color: #4ade80; }
        .wrong { color: #f87171; }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading" class="screen active">
            <h3 id="loader-text">BaÄŸlantÄ± Kuruluyor...</h3>
        </div>

        <div id="ticket-screen" class="screen">
            <h2>ðŸŽ« GÃ¼nlÃ¼k YarÄ±ÅŸma</h2>
            <div class="card">
                <div id="ad-progress" style="font-size: 1.2rem; margin-bottom: 10px;">Reklam: 0 / 3</div>
                <div id="ad-bar" style="height:10px; background:#334155; border-radius:5px; overflow:hidden;">
                    <div id="ad-fill" style="width:0%; height:100%; background:var(--accent); transition:0.3s;"></div>
                </div>
            </div>
            <button id="btn-ad" class="btn btn-ad" onclick="handleAd()">ðŸ“º VÄ°DEO Ä°ZLE</button>
            <button id="btn-start" class="btn btn-play" style="display:none;" onclick="startQuiz()">ðŸš€ YARIÅžMAYA BAÅžLA</button>
        </div>

        <div id="quiz-screen" class="screen">
            <div id="timer">0.00s</div>
            <div id="q-box" class="card"></div>
            <div id="options"></div>
        </div>

        <div id="result-screen" class="screen">
            <h2>YarÄ±ÅŸma Bitti!</h2>
            <div id="final-time" style="font-size: 2rem; color:var(--accent); margin-bottom: 20px;"></div>
            <div id="analysis"></div>
            <button class="btn btn-play" onclick="location.reload()">ðŸ”„ YENÄ°DEN DENE</button>
        </div>
    </div>

    <script>
        const SB_URL = 'https://arumdxephyjteoypjaxh.supabase.co';
        const SB_KEY = 'sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1';
        const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;
        const AdController = window.Adsgram.init({ blockId: "int-2709" });

        let userStats = { ads_watched: 0 };
        let currentIdx = 0, startTime, timerInt, penalty = 0, userChoices = [];
        const userId = tg.initDataUnsafe?.user?.id || Math.floor(Math.random() * 9999);
        const today = new Date().toLocaleDateString('tr-TR');

        const pool = [
            {q:"Hangi gezegen GÃ¼neÅŸ'e en yakÄ±ndÄ±r?", a:["VenÃ¼s","MerkÃ¼r","Mars"], c:1},
            {q:"Su kaÃ§ derecede kaynar?", a:["90","100","110"], c:1},
            {q:"TÃ¼rkiye'nin yÃ¼zÃ¶lÃ§Ã¼mÃ¼ en bÃ¼yÃ¼k ili?", a:["Ankara","Ä°stanbul","Konya"], c:2},
            {q:"Hangisi bir programlama dilidir?", a:["Python","HTML","CSS"], c:0},
            {q:"KÄ±zÄ±l Gezegen hangisidir?", a:["Mars","JÃ¼piter","SatÃ¼rn"], c:0},
            {q:"AtatÃ¼rk kaÃ§ yÄ±lÄ±nda doÄŸdu?", a:["1880","1881","1938"], c:1},
            {q:"Mona Lisa tablosu kimindir?", a:["Picasso","Da Vinci","Dali"], c:1},
            {q:"Ä°nsan vÃ¼cudundaki en bÃ¼yÃ¼k organ?", a:["Kalp","Deri","KaraciÄŸer"], c:1},
            {q:"Hangi hayvan memelidir?", a:["Balina","Timsah","YÄ±lan"], c:0},
            {q:"SatranÃ§ta kaÃ§ adet piyon vardÄ±r?", a:["8","12","16"], c:2}
        ];

        async function init() {
            try {
                // Supabase'den veri Ã§ek
                let { data, error } = await _supabase.from('user_tickets').select('*').eq('telegram_id', userId).maybeSingle();
                
                if (error) throw error;

                if (!data || data.last_date !== today) {
                    // Veri yoksa veya gÃ¼n yeniyse sÄ±fÄ±rla/oluÅŸtur
                    const { data: upsertedData, error: uError } = await _supabase.from('user_tickets')
                        .upsert({ telegram_id: userId, ads_watched: 0, last_date: today }, { onConflict: 'telegram_id' })
                        .select().single();
                    if (uError) throw uError;
                    userStats = upsertedData;
                } else {
                    userStats = data;
                }
                
                showScreen('ticket-screen');
                updateAdUI();
            } catch (err) {
                console.error(err);
                document.getElementById('loader-text').innerHTML = `Hata: ${err.message}<br><br>Supabase'de <b>user_tickets</b> tablosu kurulu mu?`;
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function handleAd() {
            const res = await AdController.show();
            if (res.done) {
                userStats.ads_watched++;
                await _supabase.from('user_tickets').update({ads_watched: userStats.ads_watched}).eq('telegram_id', userId);
                updateAdUI();
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function updateAdUI() {
            const count = userStats.ads_watched;
            document.getElementById('ad-progress').innerText = `Reklam: ${count} / 3`;
            document.getElementById('ad-fill').style.width = `${(count/3)*100}%`;
            if (count >= 3) {
                document.getElementById('btn-ad').style.display = 'none';
                document.getElementById('btn-start').style.display = 'block';
            }
        }

        function startQuiz() {
            showScreen('quiz-screen');
            startTime = Date.now();
            timerInt = setInterval(() => {
                let s = ((Date.now() - startTime) / 1000 + penalty).toFixed(2);
                document.getElementById('timer').innerText = s + "s";
            }, 50);
            renderQuestion();
        }

        function renderQuestion() {
            if (currentIdx >= pool.length) return endQuiz();
            const q = pool[currentIdx];
            document.getElementById('q-box').innerText = `${currentIdx+1}. ${q.q}`;
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = "";
            q.a.forEach((txt, i) => {
                const b = document.createElement('button');
                b.className = "btn option";
                b.innerText = txt;
                b.onclick = () => {
                    userChoices.push(i);
                    if(i !== q.c) { penalty += 5; tg.HapticFeedback.notificationOccurred('error'); }
                    currentIdx++;
                    renderQuestion();
                };
                optDiv.appendChild(b);
            });
        }

        function endQuiz() {
            clearInterval(timerInt);
            const total = ((Date.now() - startTime) / 1000 + penalty).toFixed(2);
            showScreen('result-screen');
            document.getElementById('final-time').innerText = total + "s";
            
            let html = "<h3 style='margin-top:20px'>DetaylÄ± Karne</h3>";
            pool.forEach((q, i) => {
                const correct = userChoices[i] === q.c;
                html += `
                <div class="card review-card" style="border-left-color: ${correct ? '#4ade80' : '#f87171'}">
                    <strong>${i+1}. ${q.q}</strong><br>
                    <span class="${correct ? 'correct' : 'wrong'}">Senin CevabÄ±n: ${q.a[userChoices[i]]}</span><br>
                    ${!correct ? `<span class="correct">DoÄŸru: ${q.a[q.c]}</span>` : ''}
                </div>`;
            });
            document.getElementById('analysis').innerHTML = html;
            saveScore(total);
        }

        async function saveScore(s) {
            const u = tg.initDataUnsafe?.user;
            await _supabase.from('leaderboard').insert([{
                telegram_id: userId,
                username: u?.first_name || "Oyuncu",
                score: parseFloat(s)
            }]);
        }

        window.onload = init;
    </script>
</body>
</html>
