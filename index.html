<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <div class="counter-card">
            <small style="display:block; margin-bottom:5px; opacity:0.8;">TOPLAM KATILIMCI</small>
            <div id="big-counter" class="counter-value">...</div>
        </div>

        <div class="sponsor-list">
            <div class="sponsor-box highlight">ğŸš€ Quiz Arena'ya HoÅŸ Geldiniz!</div>
            <div class="sponsor-box">Sponsor Reklam AlanÄ±</div>
            <div class="sponsor-box highlight">Bu Alana Reklam Verebilirsiniz</div>
        </div>

        <button id="entry-btn" class="btn-main" style="margin-top: 20px;">GÄ°RÄ°Å YAP</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        async function init() {
            tg.ready();
            tg.expand();

            // 1. Biletli SayÄ±sÄ±nÄ± GÃ¶ster (1388 + DB)
            try {
                const { count } = await supabaseClient
                    .from('profiles')
                    .select('*', { count: 'exact', head: true })
                    .eq('has_ticket', true);
                
                document.getElementById('big-counter').innerText = (1388 + (count || 0)).toLocaleString();
            } catch (e) {
                document.getElementById('big-counter').innerText = "1,388";
            }

            // 2. GiriÅŸ ve KayÄ±t Fonksiyonu
            document.getElementById('entry-btn').onclick = async () => {
                const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID, username: "test_user" };
                
                // Butonu geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rak (Ã‡ift tÄ±klamayÄ± Ã¶nlemek iÃ§in)
                const btn = document.getElementById('entry-btn');
                btn.disabled = true;
                btn.innerText = "GÄ°RÄ°Å YAPILIYOR...";

                // VeritabanÄ±na Kaydet (Upsert: Varsa gÃ¼ncelle, yoksa ekle)
                const { error } = await supabaseClient
                    .from('profiles')
                    .upsert({ 
                        telegram_id: user.id, 
                        username: user.username || "isimsiz",
                        // Ä°lk giriÅŸte bakiye ve bilet deÄŸiÅŸmesin diye sadece id ve username gÃ¶nderiyoruz
                    }, { onConflict: 'telegram_id' });

                if (error) {
                    console.error("KayÄ±t HatasÄ±:", error);
                    tg.showAlert("GiriÅŸ yapÄ±lamadÄ±, lÃ¼tfen tekrar deneyin.");
                    btn.disabled = false;
                    btn.innerText = "GÄ°RÄ°Å YAP";
                } else {
                    // KayÄ±t baÅŸarÄ±lÄ±ysa yÃ¶nlendir
                    window.location.href = "dashboard.html";
                }
            };
        }

        init();
    </script>
</body>
</html>
