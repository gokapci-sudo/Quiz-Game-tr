<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Master Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/adsgram-ad-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; text-align: center; }
        #app { padding: 20px; max-width: 500px; margin: auto; }
        .screen { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #334155; margin: 20px 0; }
        .btn { display: block; width: 100%; padding: 16px; margin: 10px 0; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-ad { background: #f59e0b; color: #000; }
        .btn-play { background: var(--accent); color: #000; }
        .option { background: #334155; color: white; text-align: left; margin-bottom: 10px; width: 100%; }
        #timer { font-size: 2.5rem; color: var(--accent); font-weight: 800; margin: 10px 0; }
        .review-card { text-align: left; border-left: 4px solid #334155; padding-left: 15px; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div id="app">
        <div id="ticket-screen" class="screen active">
            <h2>ðŸŽ« GÃ¼nlÃ¼k YarÄ±ÅŸma</h2>
            <div class="card">
                <div id="ad-progress" style="font-size: 1.2rem; margin-bottom: 10px;">YÃ¼kleniyor...</div>
                <div id="ad-bar" style="height:10px; background:#334155; border-radius:5px; overflow:hidden;">
                    <div id="ad-fill" style="width:0%; height:100%; background:var(--accent); transition:0.3s;"></div>
                </div>
            </div>
            <button id="btn-ad" class="btn btn-ad" onclick="handleAd()">ðŸ“º VÄ°DEO Ä°ZLE</button>
            <button id="btn-start" class="btn btn-play" style="display:none;" onclick="startQuiz()">ðŸš€ YARIÅžMAYA BAÅžLA</button>
        </div>

        <div id="quiz-screen" class="screen">
            <div id="timer">0.00s</div>
            <div id="q-box" class="card"></div>
            <div id="options"></div>
        </div>

        <div id="result-screen" class="screen">
            <h2>Bitti!</h2>
            <div id="final-time" style="font-size: 2rem; color:var(--accent); margin-bottom: 20px;"></div>
            <div id="analysis"></div>
            <button class="btn btn-play" onclick="location.reload()">ðŸ”„ TEKRAR</button>
        </div>
    </div>

    <script>
        const SB_URL = 'https://arumdxephyjteoypjaxh.supabase.co';
        const SB_KEY = 'sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1';
        const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;
        const AdController = window.Adsgram.init({ blockId: "int-2709" });

        let userStats = { ads_watched: 0 };
        let currentIdx = 0, startTime, timerInt, penalty = 0, userChoices = [];
        const userId = tg.initDataUnsafe?.user?.id || 12345;
        const today = new Date().toLocaleDateString('tr-TR');

        const pool = [
            {q:"Hangi gezegen GÃ¼neÅŸ'e en yakÄ±ndÄ±r?", a:["VenÃ¼s","MerkÃ¼r","Mars"], c:1},
            {q:"Su kaÃ§ derecede kaynar?", a:["90","100","110"], c:1},
            {q:"TÃ¼rkiye'nin yÃ¼zÃ¶lÃ§Ã¼mÃ¼ en bÃ¼yÃ¼k ili?", a:["Ankara","Ä°stanbul","Konya"], c:2},
            {q:"Hangisi bir programlama dilidir?", a:["Python","HTML","CSS"], c:0},
            {q:"KÄ±zÄ±l Gezegen hangisidir?", a:["Mars","JÃ¼piter","SatÃ¼rn"], c:0}
        ];

        // --- BASÄ°TLEÅžTÄ°RÄ°LMÄ°Åž BAÅžLATMA ---
        function init() {
            console.log("Sistem hazÄ±r.");
            // VeritabanÄ±nÄ± beklemeden UI'yÄ± gÃ¼ncelle
            updateAdUI();
            
            // Veriyi arka planda sessizce Ã§ek
            _supabase.from('user_tickets').select('*').eq('telegram_id', userId).maybeSingle()
            .then(({data}) => {
                if (data && data.last_date === today) {
                    userStats = data;
                    updateAdUI();
                }
            });
        }

        async function handleAd() {
            try {
                const res = await AdController.show();
                if (res.done) {
                    userStats.ads_watched++;
                    updateAdUI();
                    // VeritabanÄ±na yaz (baÅŸarÄ±lÄ± olup olmamasÄ±nÄ± bekleme)
                    _supabase.from('user_tickets').upsert({
                        telegram_id: userId, 
                        ads_watched: userStats.ads_watched, 
                        last_date: today 
                    }).then();
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } catch (e) {
                alert("Sponsor hazÄ±r deÄŸil, lÃ¼tfen tekrar deneyin.");
            }
        }

        function updateAdUI() {
            const count = userStats.ads_watched;
            document.getElementById('ad-progress').innerText = `Reklam: ${count} / 3`;
            document.getElementById('ad-fill').style.width = `${(count/3)*100}%`;
            if (count >= 3) {
                document.getElementById('btn-ad').style.display = 'none';
                document.getElementById('btn-start').style.display = 'block';
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startQuiz() {
            showScreen('quiz-screen');
            startTime = Date.now();
            timerInt = setInterval(() => {
                let s = ((Date.now() - startTime) / 1000 + penalty).toFixed(2);
                document.getElementById('timer').innerText = s + "s";
            }, 50);
            renderQuestion();
        }

        function renderQuestion() {
            if (currentIdx >= pool.length) return endQuiz();
            const q = pool[currentIdx];
            document.getElementById('q-box').innerText = `${currentIdx+1}. ${q.q}`;
            const optDiv = document.getElementById('options');
            optDiv.innerHTML = "";
            q.a.forEach((txt, i) => {
                const b = document.createElement('button');
                b.className = "btn option";
                b.innerText = txt;
                b.onclick = () => {
                    userChoices.push(i);
                    if(i !== q.c) { penalty += 5; tg.HapticFeedback.notificationOccurred('error'); }
                    currentIdx++;
                    renderQuestion();
                };
                optDiv.appendChild(b);
            });
        }

        function endQuiz() {
            clearInterval(timerInt);
            const total = ((Date.now() - startTime) / 1000 + penalty).toFixed(2);
            showScreen('result-screen');
            document.getElementById('final-time').innerText = total + "s";
            
            let html = "<h3 style='margin-top:20px'>Analiz</h3>";
            pool.forEach((q, i) => {
                const correct = userChoices[i] === q.c;
                html += `
                <div class="card review-card" style="border-left: 4px solid ${correct ? '#4ade80' : '#f87171'}">
                    <strong>${i+1}. ${q.q}</strong><br>
                    <span>CevabÄ±n: ${q.a[userChoices[i]]}</span><br>
                    ${!correct ? `<span>DoÄŸru: ${q.a[q.c]}</span>` : ''}
                </div>`;
            });
            document.getElementById('analysis').innerHTML = html;
            
            // Skoru kaydet
            _supabase.from('leaderboard').insert([{
                telegram_id: userId,
                username: tg.initDataUnsafe?.user?.first_name || "Oyuncu",
                score: parseFloat(total)
            }]).then();
        }

        // UygulamayÄ± baÅŸlat
        init();
    </script>
</body>
</html>
