<!DOCTYPE html>
<html lang="tr">
<head>
    <style>
        /* Ekstra GÃ¶rsel DokunuÅŸlar */
        .locked-msg { color: #94a3b8; font-style: italic; margin-top: 10px; }
        .score-box { background: rgba(56, 189, 248, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active">
        <div class="loader"></div>
        <p>Veriler GÃ¼venli Åekilde DoÄŸrulanÄ±yor...</p>
    </div>

    <div id="main-screen" class="screen">
        <div class="card">
            <h2 id="u-name">...</h2>
            <div id="status-area">
                </div>
        </div>
        <div id="action-area" style="width: 100%; max-width: 400px;">
            </div>
    </div>

    <script>
        // ... (Supabase AyarlarÄ±) ...
        const today = new Date().toISOString().split('T')[0];

        async function init() {
            try {
                tg.expand();
                const { data: userData, error } = await _supabase.from('users').select('*').eq('telegram_id', userId).maybeSingle();
                
                if (!userData) {
                    showScreen('reg-screen');
                    return;
                }
                user = userData;
                document.getElementById('u-name').innerText = `@${user.username}`;
                
                renderMainScreen();
            } catch (err) {
                console.error("BaÅŸlatma hatasÄ±", err);
            }
        }

        function renderMainScreen() {
            const statusArea = document.getElementById('status-area');
            const actionArea = document.getElementById('action-area');
            statusArea.innerHTML = "";
            actionArea.innerHTML = "";

            // DURUM 1: BugÃ¼n zaten oynamÄ±ÅŸ mÄ±?
            if (user.last_played_date === today) {
                statusArea.innerHTML = `
                    <div class="score-box">
                        <p>BugÃ¼nkÃ¼ YarÄ±ÅŸma TamamlandÄ±! âœ…</p>
                        <small>Yeni yarÄ±ÅŸma yarÄ±n 13:00'da.</small>
                    </div>`;
                actionArea.innerHTML = `<button class="btn btn-blue" onclick="fetchLeaderboard()">ğŸ† SIRALAMAYI GÃ–R</button>`;
            } 
            // DURUM 2: Bileti var mÄ±?
            else if (user.has_ticket) {
                statusArea.innerHTML = `<p style="color:var(--success)">Biletin Aktif! YarÄ±ÅŸmaya hazÄ±rsÄ±n. ğŸ«</p>`;
                actionArea.innerHTML = `
                    <button class="btn btn-blue" onclick="confirmAndStart()">ğŸš€ YARIÅMAYI BAÅLAT</button>
                    <button class="btn btn-outline" onclick="fetchLeaderboard()">ğŸ† SIRALAMA</button>`;
            } 
            // DURUM 3: Bilet almasÄ± lazÄ±m
            else {
                statusArea.innerHTML = `<p>YarÄ±ÅŸmak iÃ§in biletin yok. Reklam izleyerek bilet kazan!</p>`;
                actionArea.innerHTML = `
                    <button class="btn btn-blue" onclick="watchAd()">ğŸ“º REKLAM Ä°ZLE (%${(user.ads_watched/4)*100})</button>
                    <button class="btn btn-outline" onclick="fetchLeaderboard()">ğŸ† SIRALAMA</button>`;
            }
            showScreen('main-screen');
        }

        async function confirmAndStart() {
            tg.showConfirm("YarÄ±ÅŸma baÅŸlasÄ±n mÄ±? (GÃ¼nde sadece 1 giriÅŸ hakkÄ±n var)", async (ok) => {
                if (ok) {
                    // KRÄ°TÄ°K: YarÄ±ÅŸmaya girdiÄŸi an bileti yak ve tarihi gÃ¼ncelle
                    const { data, error } = await _supabase.from('users').update({ 
                        has_ticket: false, 
                        ads_watched: 0,
                        last_played_date: today 
                    }).eq('telegram_id', userId).select().single();
                    
                    if (!error) {
                        user = data;
                        startQuiz(); // YarÄ±ÅŸma fonksiyonunu Ã§aÄŸÄ±r
                    } else {
                        tg.showAlert("GiriÅŸ yapÄ±lamadÄ±, lÃ¼tfen tekrar dene.");
                    }
                }
            });
        }

        // ... (Soru yÃ¼kleme ve endQuiz fonksiyonlarÄ± Ã¶ncekiyle benzer, ancak endQuiz'de bilet yakma zaten confirmAndStart'ta yapÄ±ldÄ±ÄŸÄ± iÃ§in sadece skor kaydedecek) ...
        
        async function endQuiz() {
            showScreen('result-screen');
            document.getElementById('final-score').innerText = score;
            
            // Analiz dÃ¶kÃ¼mÃ¼... (Ã–nceki kod gibi)

            // Skor KaydÄ±
            await _supabase.from('daily_scores').insert([{
                telegram_id: userId, 
                username: user.username, 
                score: score, 
                play_date: today
            }]);
        }
    </script>
</body>
</html>
