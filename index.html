<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Arena - Yarƒ±≈üma Modu</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --error: #ef4444; }
        body { margin:0; background: var(--bg); color: var(--text); font-family: sans-serif; text-align:center; display: flex; flex-direction: column; min-height: 100vh; }
        .screen { display:none; padding: 20px; flex: 1; flex-direction: column; align-items: center; justify-content: center; }
        .screen.active { display:flex !important; }
        .card { background:var(--card); padding:25px; border-radius:20px; margin:10px 0; border:1px solid #334155; width: 90%; max-width: 400px; }
        .btn { display:block; width: 100%; padding:16px; border-radius:12px; border:none; font-weight:bold; cursor:pointer; margin-bottom:12px; font-size: 1rem; transition: 0.2s; color: #fff; }
        .btn-blue { background:var(--primary); color:#000; }
        .btn-option { background: #334155; text-align: left; }
        .btn-option:active { background: #475569; }
        
        /* Quiz √ñzel */
        #quiz-timer { font-size: 2rem; color: #fbbf24; font-weight: bold; margin-bottom: 20px; }
        .progress-bar { width: 100%; background: #334155; height: 10px; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
        .correct { background: var(--success) !important; }
        .wrong { background: var(--error) !important; }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active">
        <p>Y√ºkleniyor...</p>
    </div>

    <div id="main-screen" class="screen">
        <div class="card">
            <h3 id="u-name">@Oyuncu</h3>
            <p>Bilet Durumu: <span style="color:var(--success)">TEST Bƒ∞LETƒ∞ AKTƒ∞F ‚úÖ</span></p>
        </div>
        <button class="btn btn-blue" onclick="startQuiz()">üöÄ YARI≈ûMAYI BA≈ûLAT</button>
    </div>

    <div id="quiz-screen" class="screen">
        <div id="quiz-timer">15</div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div class="card">
            <h3 id="question-text">Soru y√ºkleniyor...</h3>
        </div>
        <div id="options-container" style="width: 100%; max-width: 400px;">
            </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="card">
            <h2>Yarƒ±≈üma Bitti! üèÅ</h2>
            <p id="final-score" style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">Puan: 0</p>
            <p id="stats-text">Doƒüru: 0 | Yanlƒ±≈ü: 0</p>
        </div>
        <button class="btn btn-blue" onclick="location.reload()">üîÑ ANA SAYFAYA D√ñN</button>
    </div>

    <script>
        const SB_URL = 'https://arumdxephyjteoypjaxh.supabase.co';
        const SB_KEY = 'sb_publishable_qEEOLIXhKlkLM_poqDDkhw_OkNS_yo1';
        const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;

        // √ñRNEK SORU HAVUZU (Ger√ßekte veritabanƒ±ndan √ßekilebilir)
        const questions = [
            { q: "TON hangi aƒüƒ±n kripto parasƒ±dƒ±r?", a: ["The Open Network", "Ethereum", "Solana", "Bitcoin"], c: 0 },
            { q: "Telegram'ƒ±n kurucusu kimdir?", a: ["Mark Zuckerberg", "Pavel Durov", "Elon Musk", "Bill Gates"], c: 1 },
            { q: "Blockchain teknolojisi hangisiyle ba≈ülar?", a: ["Web 2.0", "Web 3.0", "Sanayi Devrimi", "Akƒ±llƒ± Telefonlar"], c: 1 },
            { q: "Hangisi bir TON c√ºzdanƒ±dƒ±r?", a: ["Metamask", "Tonkeeper", "Phantom", "Trust Wallet"], c: 1 },
            { q: "1 TON yakla≈üƒ±k ka√ß dolardƒ±r? (Tahmini)", a: ["1$", "5$", "50$", "100$"], c: 1 }
        ];

        let currentIdx = 0;
        let score = 0;
        let timer;
        let timeLeft = 15;
        let canAnswer = true;
        let stats = { correct: 0, wrong: 0 };

        async function init() {
            tg.expand();
            // Test i√ßin kullanƒ±cƒ± ismini √ßekelim
            const userId = tg.initDataUnsafe?.user?.id || 123;
            const { data } = await _supabase.from('users').select('username').eq('telegram_id', userId).maybeSingle();
            document.getElementById('u-name').innerText = `@${data?.username || 'Oyuncu'}`;
            showScreen('main-screen');
        }

        function startQuiz() {
            currentIdx = 0;
            score = 0;
            stats = { correct: 0, wrong: 0 };
            showScreen('quiz-screen');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= questions.length) return endQuiz();
            
            canAnswer = true;
            timeLeft = 15;
            document.getElementById('quiz-timer').innerText = timeLeft;
            document.getElementById('progress-fill').style.width = `${((currentIdx + 1) / questions.length) * 100}%`;
            
            const qData = questions[currentIdx];
            document.getElementById('question-text').innerText = qData.q;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            qData.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(i, btn);
                container.appendChild(btn);
            });

            startTimer();
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('quiz-timer').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    checkAnswer(-1); // Zaman biterse yanlƒ±≈ü say
                }
            }, 1000);
        }

        async function checkAnswer(idx, btn) {
            if (!canAnswer) return;
            canAnswer = false;
            clearInterval(timer);

            const correctIdx = questions[currentIdx].c;
            const options = document.querySelectorAll('.btn-option');

            if (idx === correctIdx) {
                if(btn) btn.classList.add('correct');
                score += (timeLeft * 10); // Hƒ±zlƒ± cevap verene daha √ßok puan
                stats.correct++;
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                if(btn) btn.classList.add('wrong');
                options[correctIdx].classList.add('correct');
                stats.wrong++;
                tg.HapticFeedback.notificationOccurred('error');
            }

            setTimeout(() => {
                currentIdx++;
                loadQuestion();
            }, 1500);
        }

        async function endQuiz() {
            showScreen('result-screen');
            document.getElementById('final-score').innerText = `Puan: ${score}`;
            document.getElementById('stats-text').innerText = `Doƒüru: ${stats.correct} | Yanlƒ±≈ü: ${stats.wrong}`;
            
            // SKORU KAYDET (Supabase)
            const userId = tg.initDataUnsafe?.user?.id || 123;
            await _supabase.from('daily_scores').insert([{
                telegram_id: userId,
                username: tg.initDataUnsafe?.user?.username || "Test",
                score: score
            }]);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
