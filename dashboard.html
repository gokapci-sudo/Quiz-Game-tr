<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <span id="display-username" class="yellow-text">...</span>
            <button id="admin-panel-btn" onclick="location.href='admin.html'" class="btn-sub hidden" style="width:auto; height:30px;">Panel</button>
        </header>

        <section class="card">
            <small>Bakiyeniz</small>
            <div style="font-size:26px; font-weight:bold;"><span id="user-balance">0.00</span> TON</div>
            <button id="withdraw-btn" onclick="requestWithdraw()" class="btn-main hidden" style="background:var(--green); height:40px; margin-top:10px;">Ã‡EKÄ°M YAP (Min 2.0)</button>
            <button id="connect-btn" onclick="setWallet()" class="btn-sub" style="margin-top:10px;">ğŸ’ CÃ¼zdan BaÄŸla</button>
        </section>

        <div id="ticket-info"></div>

        <div class="grid-2">
            <button onclick="location.href='results.html'" class="btn-sub">ğŸ“Š SÄ±ralama</button>
            <button onclick="location.href='announcements.html'" class="btn-sub">ğŸ“¢ Duyurular</button>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        async function init() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('telegram_id', user.id).single();
            if(p) {
                document.getElementById('display-username').innerText = "@" + p.username;
                document.getElementById('user-balance').innerText = p.balance.toFixed(2);
                if(p.balance >= 2.0) document.getElementById('withdraw-btn').classList.remove('hidden');
                if(user.id === APP_CONFIG.adminID) document.getElementById('admin-panel-btn').classList.remove('hidden');
                
                const status = getRaceStatus();
                const area = document.getElementById('ticket-info');
                if(status.active && p.has_ticket) area.innerHTML = `<button onclick="location.href='quiz.html'" class="btn-main" style="background:var(--green)">ğŸ YARIÅMAYA GÄ°R</button>`;
                else if(p.has_ticket) area.innerHTML = `<div class="card" style="text-align:center; color:var(--green);">âœ… Bilet HazÄ±r (Saat: ${status.nextMatch})</div>`;
                else area.innerHTML = `<button onclick="location.href='bilet.html'" class="btn-main" style="background:var(--yellow); color:black;">ğŸ« BÄ°LET AL</button>`;
            }
        }
        async function requestWithdraw() {
            const user = tg.initDataUnsafe?.user || { id: APP_CONFIG.adminID };
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('telegram_id', user.id).single();
            if(!p.wallet_address) return tg.showAlert("LÃ¼tfen cÃ¼zdan baÄŸlayÄ±n!");

            // ADIM 1: Talebi GÃ¶nder
            const { error: wErr } = await supabaseClient.from('withdrawals').insert([{ 
                telegram_id: user.id, wallet_address: p.wallet_address, amount: p.balance, status: 'pending' 
            }]);

            if(wErr) return tg.showAlert("Hata: " + wErr.message);

            // ADIM 2: Bakiye SÄ±fÄ±rla
            await supabaseClient.from('profiles').update({ balance: 0 }).eq('telegram_id', user.id);
            tg.showAlert("Talep Admine iletildi!");
            location.reload();
        }
        function setWallet() {
            const addr = prompt("TON CÃ¼zdan Adresiniz:");
            if(addr) supabaseClient.from('profiles').update({ wallet_address: addr }).eq('telegram_id', tg.initDataUnsafe?.user?.id || APP_CONFIG.adminID).then(() => location.reload());
        }
        init();
    </script>
</body>
</html>
